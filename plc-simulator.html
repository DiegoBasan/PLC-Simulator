<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PLC Simulator â€” TIA Portal Style</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow:wght@300;400;500;600;700&family=Barlow+Condensed:wght@400;600;700&display=swap');

  :root {
    --bg: #1a1d21;
    --bg2: #22262d;
    --bg3: #2a2f38;
    --bg4: #333a45;
    --panel: #1e2229;
    --border: #3a4150;
    --border2: #4a5568;
    --accent: #0097e6;
    --accent2: #00d2ff;
    --green: #00c853;
    --red: #ff3d00;
    --yellow: #ffc107;
    --orange: #ff6d00;
    --purple: #7c4dff;
    --text: #e8ecf0;
    --text2: #9aacbe;
    --text3: #6b7c93;
    --siemens: #009999;
    --header-h: 48px;
    --sidebar-w: 260px;
    --toolbar-h: 40px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Barlow', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

  /* ===== HEADER ===== */
  .header {
    height: var(--header-h);
    background: linear-gradient(90deg, #0d1117 0%, #161b22 100%);
    border-bottom: 2px solid var(--siemens);
    display: flex; align-items: center; gap: 0;
    flex-shrink: 0;
    position: relative;
    z-index: 100;
  }
  .logo {
    width: var(--sidebar-w);
    display: flex; align-items: center; gap: 10px;
    padding: 0 16px;
    border-right: 1px solid var(--border);
    height: 100%;
    flex-shrink: 0;
  }
  .logo-icon { width: 28px; height: 28px; background: var(--siemens); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; color: #fff; letter-spacing: -1px; }
  .logo-text { font-size: 13px; font-weight: 600; color: var(--text); line-height: 1.2; }
  .logo-text span { display: block; font-size: 10px; color: var(--siemens); font-weight: 400; letter-spacing: 1px; text-transform: uppercase; }
  .header-nav { display: flex; align-items: center; height: 100%; flex: 1; }
  .header-nav button {
    height: 100%; padding: 0 14px; font-size: 12px; font-family: 'Barlow', sans-serif;
    background: none; border: none; color: var(--text2); cursor: pointer;
    border-right: 1px solid var(--border);
    transition: all 0.15s;
  }
  .header-nav button:hover { background: var(--bg3); color: var(--text); }
  .header-status { display: flex; align-items: center; gap: 12px; padding: 0 16px; margin-left: auto; }
  .status-badge {
    display: flex; align-items: center; gap: 5px; padding: 3px 10px;
    border-radius: 3px; font-size: 11px; font-weight: 600; letter-spacing: 0.5px;
    font-family: 'Share Tech Mono', monospace;
  }
  .status-badge.stop { background: rgba(255,61,0,0.15); color: var(--red); border: 1px solid rgba(255,61,0,0.3); }
  .status-badge.run { background: rgba(0,200,83,0.15); color: var(--green); border: 1px solid rgba(0,200,83,0.3); }
  .status-badge.sim { background: rgba(0,151,230,0.15); color: var(--accent2); border: 1px solid rgba(0,151,230,0.3); }
  .status-dot { width: 7px; height: 7px; border-radius: 50%; }
  .status-badge.stop .status-dot { background: var(--red); }
  .status-badge.run .status-dot { background: var(--green); box-shadow: 0 0 6px var(--green); animation: pulse 1s infinite; }
  .status-badge.sim .status-dot { background: var(--accent2); box-shadow: 0 0 6px var(--accent2); animation: pulse 0.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* ===== TOOLBAR ===== */
  .toolbar {
    height: var(--toolbar-h); background: var(--bg2);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 2px; padding: 0 8px;
    flex-shrink: 0;
  }
  .tb-sep { width: 1px; height: 24px; background: var(--border); margin: 0 4px; }
  .tb-btn {
    height: 28px; min-width: 28px; padding: 0 8px;
    background: none; border: 1px solid transparent;
    border-radius: 3px; color: var(--text2); cursor: pointer;
    font-size: 11px; font-family: 'Barlow', sans-serif;
    display: flex; align-items: center; gap: 5px;
    transition: all 0.12s;
  }
  .tb-btn:hover { background: var(--bg4); border-color: var(--border); color: var(--text); }
  .tb-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
  .tb-btn.run-btn { background: rgba(0,200,83,0.12); border-color: rgba(0,200,83,0.4); color: var(--green); }
  .tb-btn.run-btn:hover { background: var(--green); color: #000; }
  .tb-btn.stop-btn { background: rgba(255,61,0,0.12); border-color: rgba(255,61,0,0.4); color: var(--red); }
  .tb-btn.stop-btn:hover { background: var(--red); color: #fff; }
  .tb-btn.sim-btn { background: rgba(0,151,230,0.12); border-color: rgba(0,151,230,0.4); color: var(--accent); }
  .tb-btn.sim-btn:hover { background: var(--accent); color: #fff; }
  .tb-btn.force-btn { background: rgba(255,193,7,0.12); border-color: rgba(255,193,7,0.4); color: var(--yellow); }
  .tb-btn.force-btn:hover { background: var(--yellow); color: #000; }

  /* ===== MAIN LAYOUT ===== */
  .main { display: flex; flex: 1; overflow: hidden; }

  /* ===== SIDEBAR ===== */
  .sidebar {
    width: var(--sidebar-w); background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    flex-shrink: 0; overflow: hidden;
  }
  .sidebar-tabs { display: flex; border-bottom: 1px solid var(--border); }
  .sidebar-tab {
    flex: 1; height: 32px; font-size: 10px; font-weight: 600;
    letter-spacing: 0.5px; text-transform: uppercase;
    background: none; border: none; color: var(--text3);
    cursor: pointer; border-bottom: 2px solid transparent;
    transition: all 0.15s;
  }
  .sidebar-tab.active { color: var(--accent); border-bottom-color: var(--accent); background: rgba(0,151,230,0.05); }
  .sidebar-content { flex: 1; overflow-y: auto; padding: 8px 0; }
  .sidebar-content::-webkit-scrollbar { width: 4px; }
  .sidebar-content::-webkit-scrollbar-track { background: transparent; }
  .sidebar-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .tree-item {
    display: flex; align-items: center; gap: 6px;
    padding: 5px 12px 5px 8px; cursor: pointer;
    font-size: 12px; color: var(--text2); user-select: none;
    transition: all 0.1s;
  }
  .tree-item:hover { background: var(--bg3); color: var(--text); }
  .tree-item.active { background: rgba(0,151,230,0.12); color: var(--accent); }
  .tree-item .icon { width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; }
  .tree-label { font-size: 11px; }
  .tree-group { padding: 6px 8px 2px; font-size: 9px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text3); }
  .tree-indent { padding-left: 24px; }

  /* blocks palette */
  .block-palette { padding: 8px; display: flex; flex-direction: column; gap: 4px; }
  .palette-item {
    padding: 7px 10px; background: var(--bg3); border: 1px solid var(--border);
    border-radius: 4px; cursor: grab; font-size: 11px; color: var(--text2);
    display: flex; align-items: center; gap: 8px;
    transition: all 0.12s;
  }
  .palette-item:hover { background: var(--bg4); border-color: var(--border2); color: var(--text); }
  .palette-item:active { cursor: grabbing; }
  .palette-color { width: 10px; height: 10px; border-radius: 2px; flex-shrink: 0; }

  /* ===== EDITOR AREA ===== */
  .editor-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .editor-tabs { display: flex; background: var(--bg2); border-bottom: 1px solid var(--border); padding: 0 8px; gap: 2px; align-items: flex-end; }
  .editor-tab {
    padding: 0 14px; height: 30px; font-size: 11px;
    background: var(--bg3); border: 1px solid var(--border); border-bottom: none;
    color: var(--text2); cursor: pointer; border-radius: 3px 3px 0 0;
    display: flex; align-items: center; gap: 6px;
    transition: all 0.12s;
  }
  .editor-tab.active { background: var(--bg); color: var(--text); border-color: var(--border2); }
  .editor-tab .close-tab { width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 10px; opacity: 0.5; }
  .editor-tab .close-tab:hover { background: var(--border2); opacity: 1; }

  .ladder-canvas {
    flex: 1; overflow: auto; padding: 20px;
    background: var(--bg);
    background-image:
      linear-gradient(rgba(58,65,80,0.3) 1px, transparent 1px),
      linear-gradient(90deg, rgba(58,65,80,0.3) 1px, transparent 1px);
    background-size: 20px 20px;
  }
  .ladder-canvas::-webkit-scrollbar { width: 8px; height: 8px; }
  .ladder-canvas::-webkit-scrollbar-track { background: var(--bg2); }
  .ladder-canvas::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  /* ===== LADDER LOGIC ===== */
  .ladder-rung {
    display: flex; align-items: center; margin-bottom: 4px;
    position: relative; min-height: 60px;
  }
  .rung-number {
    width: 32px; font-size: 10px; color: var(--text3);
    font-family: 'Share Tech Mono', monospace; text-align: right;
    padding-right: 8px; flex-shrink: 0; user-select: none;
  }
  .rung-body {
    flex: 1; display: flex; align-items: center;
    border: 1px solid var(--border); border-radius: 4px;
    background: var(--bg2); min-height: 60px;
    position: relative; overflow: visible;
    padding: 0 8px;
  }
  .rung-body.energized { border-color: var(--green); box-shadow: 0 0 8px rgba(0,200,83,0.2); }
  .rung-powerline {
    position: absolute; top: 50%; left: 0; right: 0;
    height: 2px; background: var(--border2); z-index: 0;
    transform: translateY(-50%);
    transition: background 0.2s;
  }
  .rung-body.energized .rung-powerline { background: var(--green); box-shadow: 0 0 6px var(--green); }

  /* ===== LADDER ELEMENTS ===== */
  .ladder-el {
    display: flex; flex-direction: column; align-items: center;
    position: relative; z-index: 1; margin: 0 4px; min-width: 60px;
  }
  .el-label {
    font-size: 9px; font-family: 'Share Tech Mono', monospace;
    color: var(--text3); text-align: center; margin-bottom: 2px;
    max-width: 70px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .el-body {
    width: 50px; height: 36px; display: flex; align-items: center; justify-content: center;
    position: relative; cursor: pointer; user-select: none;
    transition: all 0.15s;
  }
  .el-body:hover { filter: brightness(1.3); }
  .el-address {
    font-size: 9px; font-family: 'Share Tech Mono', monospace;
    color: var(--text3); margin-top: 2px; text-align: center;
  }

  /* Contacts */
  .contact-NO, .contact-NC, .contact-P, .contact-N {
    width: 46px; height: 32px; position: relative;
    display: flex; align-items: center; justify-content: center;
  }
  .contact-NO::before, .contact-NO::after {
    content: ''; position: absolute; top: 50%; width: 12px; height: 2px;
    background: var(--border2); transform: translateY(-50%);
  }
  .contact-NO::before { left: 0; }
  .contact-NO::after { right: 0; }
  .contact-bar {
    width: 2px; height: 24px; background: var(--border2);
    box-shadow: 4px 0 0 var(--border2);
    margin: 0 8px;
  }
  .contact-NO.active .contact-bar,
  .contact-NO.active::before,
  .contact-NO.active::after { background: var(--green); box-shadow: 0 0 6px var(--green); }

  /* NC - diagonal cross */
  .contact-NC-bars { position: relative; width: 18px; height: 24px; margin: 0 6px; }
  .contact-NC-bars::before, .contact-NC-bars::after {
    content: ''; position: absolute; width: 2px; height: 24px;
    background: var(--border2); left: 4px;
  }
  .contact-NC-bars::after { left: 12px; }
  .slash { position: absolute; width: 22px; height: 2px; background: var(--orange); top: 50%; left: -2px; transform: rotate(-45deg) translateY(-50%); transform-origin: center; }
  .contact-NC.active .contact-NC-bars::before,
  .contact-NC.active .contact-NC-bars::after { background: var(--green); }

  /* Coils */
  .coil-body {
    width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--border2);
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; color: var(--text3);
  }
  .coil-body.active { border-color: var(--green); color: var(--green); box-shadow: 0 0 10px rgba(0,200,83,0.5); background: rgba(0,200,83,0.1); }
  .coil-body.set-coil { border-color: var(--accent); }
  .coil-body.set-coil.active { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 10px rgba(0,151,230,0.5); background: rgba(0,151,230,0.1); }
  .coil-wire { width: 8px; height: 2px; background: var(--border2); }
  .coil-body.active + .coil-wire,
  .coil-body.set-coil.active + .coil-wire { background: var(--green); }

  /* Function Blocks */
  .fb-block {
    background: var(--bg3); border: 2px solid var(--border);
    border-radius: 4px; padding: 6px 10px; min-width: 90px;
    position: relative; margin: 0 6px;
  }
  .fb-block.active { border-color: var(--siemens); box-shadow: 0 0 10px rgba(0,153,153,0.3); }
  .fb-title {
    font-size: 9px; font-weight: 700; letter-spacing: 0.5px;
    text-transform: uppercase; color: var(--siemens);
    border-bottom: 1px solid var(--border); padding-bottom: 3px; margin-bottom: 4px;
  }
  .fb-pins { display: flex; gap: 8px; }
  .fb-inputs, .fb-outputs { display: flex; flex-direction: column; gap: 3px; }
  .fb-pin { display: flex; align-items: center; gap: 4px; font-size: 9px; color: var(--text3); font-family: 'Share Tech Mono', monospace; }
  .fb-pin-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--border2); }
  .fb-pin-dot.active { background: var(--green); box-shadow: 0 0 4px var(--green); }
  .fb-pin-dot.out { background: var(--accent); }
  .fb-pin-dot.out.active { background: var(--green); }

  /* Rung add button */
  .add-rung-btn {
    display: flex; align-items: center; gap: 6px;
    padding: 6px 12px; background: none; border: 1px dashed var(--border);
    border-radius: 4px; color: var(--text3); cursor: pointer; font-size: 11px;
    margin-top: 8px; width: 100%;
    transition: all 0.15s;
  }
  .add-rung-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(0,151,230,0.05); }

  /* ===== RIGHT PANEL ===== */
  .right-panel {
    width: 280px; background: var(--panel);
    border-left: 1px solid var(--border);
    display: flex; flex-direction: column;
    flex-shrink: 0;
  }
  .rpanel-tabs { display: flex; border-bottom: 1px solid var(--border); }
  .rpanel-tab {
    flex: 1; height: 32px; font-size: 10px; font-weight: 600;
    letter-spacing: 0.5px; text-transform: uppercase;
    background: none; border: none; color: var(--text3);
    cursor: pointer; border-bottom: 2px solid transparent;
    transition: all 0.15s;
  }
  .rpanel-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .rpanel-content { flex: 1; overflow-y: auto; }
  .rpanel-content::-webkit-scrollbar { width: 4px; }
  .rpanel-content::-webkit-scrollbar-thumb { background: var(--border); }

  /* ===== IO TABLE ===== */
  .io-table { width: 100%; border-collapse: collapse; font-size: 11px; }
  .io-table th {
    background: var(--bg3); color: var(--text3); font-size: 9px;
    font-weight: 600; letter-spacing: 1px; text-transform: uppercase;
    padding: 6px 8px; text-align: left; border-bottom: 1px solid var(--border);
    position: sticky; top: 0;
  }
  .io-table td { padding: 4px 8px; border-bottom: 1px solid rgba(58,65,80,0.5); vertical-align: middle; }
  .io-table tr:hover td { background: var(--bg3); }
  .io-row.input td:first-child { border-left: 2px solid var(--accent); }
  .io-row.output td:first-child { border-left: 2px solid var(--green); }
  .io-row.marker td:first-child { border-left: 2px solid var(--yellow); }

  .signal-led {
    width: 12px; height: 12px; border-radius: 50%;
    background: var(--bg4); border: 1px solid var(--border2);
    cursor: pointer; transition: all 0.15s;
    display: inline-block;
  }
  .signal-led.on-I { background: var(--accent2); box-shadow: 0 0 6px var(--accent2); }
  .signal-led.on-Q { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .signal-led.on-M { background: var(--yellow); box-shadow: 0 0 5px var(--yellow); }
  .signal-led.forced { border: 2px solid var(--orange) !important; animation: forceflash 0.8s infinite; }
  @keyframes forceflash { 0%,100%{box-shadow:0 0 0 0 var(--orange)} 50%{box-shadow:0 0 8px 2px var(--orange)} }

  .force-btn-small {
    width: 22px; height: 14px; font-size: 8px; font-weight: 700;
    border-radius: 2px; border: 1px solid var(--border);
    background: var(--bg4); color: var(--text3); cursor: pointer;
    transition: all 0.12s;
  }
  .force-btn-small.active { background: var(--orange); border-color: var(--orange); color: #000; }

  .address-cell { font-family: 'Share Tech Mono', monospace; color: var(--accent); font-size: 10px; }
  .name-cell { color: var(--text); font-size: 11px; }
  .val-cell { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--text2); }

  /* ===== DB / VAR TABLE ===== */
  .db-row { display: flex; padding: 5px 10px; gap: 8px; font-size: 11px; border-bottom: 1px solid rgba(58,65,80,0.4); align-items: center; }
  .db-row:hover { background: var(--bg3); }
  .db-type-tag { padding: 1px 6px; border-radius: 2px; font-size: 9px; font-weight: 600; font-family: 'Share Tech Mono', monospace; }
  .tag-BOOL { background: rgba(0,151,230,0.2); color: var(--accent); }
  .tag-INT { background: rgba(124,77,255,0.2); color: var(--purple); }
  .tag-REAL { background: rgba(255,109,0,0.2); color: var(--orange); }
  .tag-WORD { background: rgba(255,193,7,0.2); color: var(--yellow); }
  .db-val { font-family: 'Share Tech Mono', monospace; color: var(--text2); font-size: 10px; margin-left: auto; }
  .db-editable { background: var(--bg3); border: 1px solid var(--border); color: var(--text); font-family: 'Share Tech Mono', monospace; font-size: 10px; width: 60px; text-align: right; padding: 1px 4px; border-radius: 2px; }
  .db-editable:focus { outline: none; border-color: var(--accent); }

  /* ===== BOTTOM PANEL ===== */
  .bottom-panel {
    height: 160px; background: var(--panel);
    border-top: 1px solid var(--border);
    display: flex; flex-direction: column;
    flex-shrink: 0;
  }
  .bottom-tabs { display: flex; border-bottom: 1px solid var(--border); }
  .bottom-tab {
    padding: 0 14px; height: 28px; font-size: 10px; font-weight: 600;
    letter-spacing: 0.5px; text-transform: uppercase;
    background: none; border: none; color: var(--text3);
    cursor: pointer; border-bottom: 2px solid transparent;
    transition: all 0.15s;
  }
  .bottom-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .log-content { flex: 1; overflow-y: auto; padding: 6px 12px; font-family: 'Share Tech Mono', monospace; font-size: 10px; }
  .log-content::-webkit-scrollbar { width: 4px; }
  .log-content::-webkit-scrollbar-thumb { background: var(--border); }
  .log-line { padding: 1px 0; color: var(--text2); }
  .log-line .ts { color: var(--text3); margin-right: 8px; }
  .log-line.info .tag { color: var(--accent); }
  .log-line.warn .tag { color: var(--yellow); }
  .log-line.ok .tag { color: var(--green); }
  .log-line.err .tag { color: var(--red); }

  /* ===== MODAL / FORCE DIALOG ===== */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    display: flex; align-items: center; justify-content: center;
    z-index: 999; display: none;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--bg2); border: 1px solid var(--border2);
    border-radius: 6px; width: 420px; overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  }
  .modal-header {
    padding: 12px 16px; background: var(--bg3); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    font-size: 12px; font-weight: 600;
  }
  .modal-header .close { background: none; border: none; color: var(--text3); cursor: pointer; font-size: 16px; }
  .modal-body { padding: 16px; }
  .modal-force-table { width: 100%; font-size: 11px; }
  .modal-force-table th { color: var(--text3); font-size: 10px; letter-spacing: 1px; padding: 4px 8px; text-align: left; }
  .modal-force-table td { padding: 4px 8px; border-bottom: 1px solid rgba(58,65,80,0.4); }
  .force-toggle { position: relative; width: 32px; height: 16px; cursor: pointer; }
  .force-toggle input { opacity: 0; width: 0; height: 0; }
  .force-slider {
    position: absolute; inset: 0; background: var(--bg4);
    border-radius: 8px; border: 1px solid var(--border2);
    transition: all 0.2s;
  }
  .force-slider::after {
    content: ''; position: absolute; width: 10px; height: 10px;
    background: var(--text3); border-radius: 50%; top: 2px; left: 2px;
    transition: all 0.2s;
  }
  .force-toggle input:checked + .force-slider { background: var(--orange); border-color: var(--orange); }
  .force-toggle input:checked + .force-slider::after { transform: translateX(16px); background: #fff; }

  /* ===== ADD ELEMENT MENU ===== */
  .context-menu {
    position: fixed; background: var(--bg2); border: 1px solid var(--border2);
    border-radius: 4px; z-index: 500; min-width: 180px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    display: none;
  }
  .context-menu.open { display: block; }
  .ctx-item {
    padding: 7px 14px; font-size: 11px; color: var(--text2);
    cursor: pointer; display: flex; align-items: center; gap: 8px;
    transition: all 0.1s;
  }
  .ctx-item:hover { background: var(--bg3); color: var(--text); }
  .ctx-item .ctx-icon { width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; }
  .ctx-sep { height: 1px; background: var(--border); margin: 4px 0; }

  /* ===== SCAN TIME DISPLAY ===== */
  .scan-info { display: flex; align-items: center; gap: 12px; padding: 0 16px; font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--text3); }
  .scan-info span { color: var(--siemens); }

  /* ===== NETWORK DIAGRAM ===== */
  .network-block {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: 4px; margin-bottom: 8px; overflow: hidden;
  }
  .network-header {
    padding: 6px 12px; background: var(--bg3); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 8px; font-size: 11px;
  }
  .network-num { font-family: 'Share Tech Mono', monospace; color: var(--text3); font-size: 10px; }
  .network-title { color: var(--text); }
  .network-comment { color: var(--text3); font-size: 10px; margin-left: auto; font-style: italic; }

  /* Tooltip */
  [data-tip] { position: relative; }
  [data-tip]:hover::after {
    content: attr(data-tip);
    position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
    background: var(--bg4); color: var(--text); font-size: 10px;
    padding: 3px 7px; border-radius: 3px; white-space: nowrap;
    border: 1px solid var(--border); z-index: 1000; pointer-events: none;
  }

  /* Responsive tweaks */
  @media (max-width: 1200px) { .right-panel { width: 240px; } }

  /* ===== LATCH / PARALLEL BRANCH ===== */
  .rung-with-latch {
    display: flex;
    flex-direction: column;
    position: relative;
    flex: 1;
  }
  .rung-main-row {
    display: flex;
    align-items: center;
    padding: 0 8px;
    min-height: 60px;
    position: relative;
  }
  .rung-latch-row {
    display: flex;
    align-items: center;
    padding: 0 8px;
    min-height: 46px;
    position: relative;
    margin-top: -2px;
  }
  /* Left vertical bar connecting the two parallel branches */
  .latch-branch-wrap {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }
  .latch-vert-left {
    position: absolute;
    left: 18px;
    top: 0; bottom: 0;
    width: 2px;
    background: var(--border2);
    z-index: 2;
    transition: background 0.2s;
  }
  .latch-vert-left.active { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .latch-vert-right {
    position: absolute;
    right: 8px;
    top: 0; bottom: 0;
    width: 2px;
    background: var(--border2);
    z-index: 2;
    transition: background 0.2s;
  }
  .latch-vert-right.active { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .latch-hline {
    height: 2px;
    background: var(--border2);
    flex: 1;
    transition: background 0.2s;
  }
  .latch-hline.active { background: var(--green); box-shadow: 0 0 5px var(--green); }
  /* Indent latch row elements */
  .rung-latch-row .ladder-el { opacity: 0.95; }

  /* ===== HMI PANEL ===== */
  .hmi-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 800;
    display: none;
    align-items: center;
    justify-content: center;
  }
  .hmi-overlay.open { display: flex; }
  .hmi-window {
    background: #1a1e24;
    border: 2px solid #3a4150;
    border-radius: 8px;
    width: 900px;
    max-width: 96vw;
    height: 620px;
    max-height: 92vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 30px 80px rgba(0,0,0,0.8);
    overflow: hidden;
    resize: both;
  }
  .hmi-titlebar {
    background: linear-gradient(90deg, #0d1117, #1a2030);
    border-bottom: 2px solid var(--siemens);
    padding: 0 14px;
    height: 42px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: move;
    user-select: none;
    flex-shrink: 0;
  }
  .hmi-title-icon { width: 22px; height: 22px; background: var(--siemens); border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #fff; }
  .hmi-title-text { font-size: 13px; font-weight: 600; color: var(--text); flex: 1; }
  .hmi-titlebar-btns { display: flex; gap: 6px; }
  .hmi-tb-btn { width: 26px; height: 26px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg3); color: var(--text2); cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.12s; }
  .hmi-tb-btn:hover { background: var(--bg4); color: var(--text); }
  .hmi-tb-btn.red:hover { background: var(--red); border-color: var(--red); color: #fff; }

  .hmi-toolbar {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 6px 12px;
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
    flex-wrap: wrap;
  }
  .hmi-tool { padding: 4px 10px; font-size: 10px; font-weight: 600; letter-spacing: 0.5px; background: var(--bg3); border: 1px solid var(--border); border-radius: 3px; color: var(--text2); cursor: pointer; transition: all 0.12s; }
  .hmi-tool:hover { background: var(--bg4); color: var(--text); border-color: var(--border2); }
  .hmi-tool.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  .hmi-body {
    flex: 1;
    display: flex;
    overflow: hidden;
  }
  .hmi-canvas {
    flex: 1;
    position: relative;
    overflow: hidden;
    background: #0f1216;
    background-image: radial-gradient(circle, rgba(0,153,153,0.06) 1px, transparent 1px);
    background-size: 24px 24px;
  }
  .hmi-canvas-inner {
    position: absolute;
    inset: 0;
  }
  .hmi-props {
    width: 200px;
    background: var(--panel);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow-y: auto;
  }
  .hmi-props-title { padding: 8px 12px; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--text3); border-bottom: 1px solid var(--border); }
  .hmi-prop-row { padding: 6px 10px; border-bottom: 1px solid rgba(58,65,80,0.4); }
  .hmi-prop-label { font-size: 9px; color: var(--text3); margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; }
  .hmi-prop-input { width: 100%; background: var(--bg3); border: 1px solid var(--border); border-radius: 2px; color: var(--text); font-size: 11px; padding: 3px 6px; font-family: 'Barlow', sans-serif; }
  .hmi-prop-input:focus { outline: none; border-color: var(--accent); }

  /* ===== HMI WIDGETS ===== */
  .hmi-widget {
    position: absolute;
    cursor: move;
    user-select: none;
    transition: box-shadow 0.15s;
  }
  .hmi-widget:hover { z-index: 10; }
  .hmi-widget.selected { outline: 2px solid var(--accent); outline-offset: 3px; z-index: 20; }

  /* Pushbutton */
  .hmi-pb {
    width: 70px; height: 70px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 4px; cursor: pointer;
  }
  .hmi-pb-btn {
    width: 52px; height: 52px;
    border-radius: 50%;
    border: 3px solid rgba(0,0,0,0.4);
    box-shadow: 0 4px 0 rgba(0,0,0,0.5), inset 0 -3px 6px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.1);
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; font-weight: 700; letter-spacing: 0.5px; color: rgba(255,255,255,0.9);
    transition: all 0.08s;
    cursor: pointer;
    position: relative;
  }
  .hmi-pb-btn:active, .hmi-pb-btn.pressed {
    transform: translateY(3px);
    box-shadow: 0 1px 0 rgba(0,0,0,0.5), inset 0 2px 6px rgba(0,0,0,0.6);
  }
  .hmi-pb-label { font-size: 9px; color: #aab; text-align: center; font-family: 'Share Tech Mono', monospace; }

  /* Switch */
  .hmi-sw {
    width: 80px; height: 70px;
    display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px;
  }
  .hmi-sw-body {
    width: 60px; height: 28px;
    background: #1a1e24;
    border: 2px solid #333;
    border-radius: 14px;
    position: relative;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: inset 0 2px 6px rgba(0,0,0,0.5);
  }
  .hmi-sw-body.on { background: #003322; border-color: var(--green); box-shadow: inset 0 2px 6px rgba(0,0,0,0.5), 0 0 10px rgba(0,200,83,0.3); }
  .hmi-sw-knob {
    position: absolute;
    width: 22px; height: 22px;
    background: linear-gradient(135deg, #666, #333);
    border-radius: 50%;
    top: 1px; left: 2px;
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.5);
  }
  .hmi-sw-body.on .hmi-sw-knob { left: 32px; background: linear-gradient(135deg, var(--green), #009944); }
  .hmi-sw-label { font-size: 9px; color: #aab; font-family: 'Share Tech Mono', monospace; text-align: center; }

  /* Pilot light */
  .hmi-light {
    width: 70px; height: 70px;
    display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
  }
  .hmi-light-bulb {
    width: 46px; height: 46px;
    border-radius: 50%;
    border: 3px solid rgba(0,0,0,0.4);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    transition: all 0.15s;
    position: relative;
    overflow: hidden;
  }
  .hmi-light-bulb::after {
    content: '';
    position: absolute;
    top: 4px; left: 8px;
    width: 12px; height: 8px;
    background: rgba(255,255,255,0.25);
    border-radius: 50%;
    transform: rotate(-30deg);
  }
  .hmi-light-bulb.on { animation: lightPulse 1.5s ease-in-out infinite; }
  @keyframes lightPulse { 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.3)} }
  .hmi-light-label { font-size: 9px; color: #aab; font-family: 'Share Tech Mono', monospace; text-align: center; }

  /* Motor */
  .hmi-motor {
    width: 90px; height: 90px;
    display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
  }
  .hmi-motor-body {
    width: 68px; height: 68px;
    border-radius: 50%;
    border: 4px solid #333;
    background: radial-gradient(circle at 35% 35%, #3a3f4a, #1a1e24);
    display: flex; align-items: center; justify-content: center;
    position: relative;
    overflow: hidden;
    transition: all 0.3s;
  }
  .hmi-motor-body.running {
    border-color: var(--green);
    box-shadow: 0 0 20px rgba(0,200,83,0.4);
  }
  .hmi-motor-body.fault {
    border-color: var(--red);
    box-shadow: 0 0 20px rgba(255,61,0,0.4);
    animation: faultFlash 0.5s infinite;
  }
  @keyframes faultFlash { 0%,100%{opacity:1} 50%{opacity:0.6} }
  .hmi-motor-rotor {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: radial-gradient(circle, #555, #2a2f38);
    border: 2px solid #444;
    position: relative;
    transition: all 0.3s;
  }
  .hmi-motor-rotor.spinning { animation: motorSpin 0.6s linear infinite; }
  @keyframes motorSpin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
  .hmi-motor-rotor::before {
    content: '';
    position: absolute;
    top: 4px; left: 50%; transform: translateX(-50%);
    width: 3px; height: 12px;
    background: #888;
    border-radius: 2px;
  }
  .hmi-motor-label { font-size: 9px; color: #aab; font-family: 'Share Tech Mono', monospace; text-align: center; }
  .hmi-motor-rpm { font-size: 8px; font-family: 'Share Tech Mono', monospace; color: var(--text3); }

  /* Gauge */
  .hmi-gauge {
    width: 90px; height: 90px;
    display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;
  }
  .hmi-gauge-svg { width: 72px; height: 72px; }

  /* Conveyor */
  .hmi-conveyor {
    width: 160px; height: 60px;
    display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
  }
  .hmi-conveyor-belt {
    width: 150px; height: 28px;
    background: #222;
    border: 2px solid #444;
    border-radius: 14px;
    position: relative;
    overflow: hidden;
  }
  .hmi-conveyor-belt.running {
    border-color: var(--green);
  }
  .hmi-conveyor-strip {
    position: absolute;
    top: 0; left: -100%;
    width: 200%;
    height: 100%;
    background: repeating-linear-gradient(90deg, transparent 0px, transparent 18px, rgba(255,255,255,0.08) 18px, rgba(255,255,255,0.08) 20px);
  }
  .hmi-conveyor-belt.running .hmi-conveyor-strip {
    animation: beltMove 1s linear infinite;
  }
  @keyframes beltMove { from{transform:translateX(0)} to{transform:translateX(40px)} }

  /* Valve */
  .hmi-valve {
    width: 70px; height: 80px;
    display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
  }
  .hmi-valve-body {
    width: 50px; height: 44px;
    position: relative;
    display: flex; align-items: center; justify-content: center;
  }
  .hmi-valve-svg { width: 50px; height: 44px; }

  /* Widget selection glow */
  .hmi-widget.selected .hmi-pb-btn,
  .hmi-widget.selected .hmi-sw-body,
  .hmi-widget.selected .hmi-light-bulb,
  .hmi-widget.selected .hmi-motor-body { outline: 2px dashed var(--accent); outline-offset: 4px; }

  /* Grid snap indicator */
  .hmi-grid-label { position: absolute; top: 4px; right: 8px; font-size: 9px; color: rgba(0,153,153,0.4); font-family: 'Share Tech Mono', monospace; pointer-events: none; }
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<div class="header">
  <div class="logo">
    <div class="logo-icon">S7</div>
    <div class="logo-text">PLC Simulator<span>TIA Portal Style v1.0</span></div>
  </div>
  <div class="header-nav">
    <button onclick="showFileMenu()">Proyecto</button>
    <button>Editar</button>
    <button>Ver</button>
    <button onclick="compileAll()">Compilar</button>
    <button onclick="openForceModal()">Forzar</button>
    <button>DiagnÃ³stico</button>
    <button>Online</button>
    <button>Ayuda</button>
  </div>
  <div class="scan-info">
    Ciclo: <span id="scanTime">0.0</span> ms | Errores: <span id="errCount">0</span>
  </div>
  <div class="header-status">
    <div class="status-badge" id="plcStatus"><div class="status-dot"></div><span id="statusText">STOP</span></div>
  </div>
</div>

<!-- ===== TOOLBAR ===== -->
<div class="toolbar">
  <button class="tb-btn run-btn" onclick="startPLC()" data-tip="Arrancar PLC (F5)">â–¶ RUN</button>
  <button class="tb-btn stop-btn" onclick="stopPLC()" data-tip="Detener PLC (F4)">â–  STOP</button>
  <button class="tb-btn sim-btn" id="simBtn" onclick="toggleSim()" data-tip="Activar simulaciÃ³n online">âš¡ SIMULAR</button>
  <div class="tb-sep"></div>
  <button class="tb-btn force-btn" onclick="openForceModal()" data-tip="Forzar seÃ±ales (Ctrl+F)">âš  FORZAR</button>
  <div class="tb-sep"></div>
  <button class="tb-btn" onclick="addNetwork()" data-tip="Nuevo network">+ Network</button>
  <button class="tb-btn" onclick="compileAll()" data-tip="Compilar programa">ðŸ”§ Compilar</button>
  <button class="tb-btn" onclick="clearForces()" data-tip="Borrar todos los forzados">âœ– Borrar Fuerzas</button>
  <div class="tb-sep"></div>
  <button class="tb-btn" onclick="showBlocksTab('OB')">OB</button>
  <button class="tb-btn" onclick="showBlocksTab('FB')">FB</button>
  <button class="tb-btn" onclick="showBlocksTab('FC')">FC</button>
  <button class="tb-btn" onclick="showBlocksTab('DB')">DB</button>
  <div class="tb-sep"></div>
  <button class="tb-btn" onclick="addNewIO('I')">+ Entrada</button>
  <button class="tb-btn" onclick="addNewIO('Q')">+ Salida</button>
  <button class="tb-btn" onclick="addNewIO('M')">+ Marca</button>
  <div class="tb-sep"></div>
  <button class="tb-btn" style="background:rgba(0,153,153,0.15);border-color:rgba(0,153,153,0.5);color:var(--siemens)" onclick="openHMI()">ðŸ–¥ Panel HMI</button>
</div>

<!-- ===== MAIN ===== -->
<div class="main">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-tabs">
      <button class="sidebar-tab active" onclick="showSideTab('project',this)">Proyecto</button>
      <button class="sidebar-tab" onclick="showSideTab('blocks',this)">Bloques</button>
      <button class="sidebar-tab" onclick="showSideTab('library',this)">Libr.</button>
    </div>

    <!-- Project tree -->
    <div class="sidebar-content" id="sideProject">
      <div class="tree-group">PLC_1 [CPU 1516-3 PN/DP]</div>
      <div class="tree-item active" onclick="openTab('main','OB1 Main')">
        <div class="icon">ðŸ“‹</div><div class="tree-label">OB1 [Main]</div>
      </div>
      <div class="tree-item" onclick="openTab('startup','OB100 Startup')">
        <div class="icon">ðŸ”„</div><div class="tree-label">OB100 [Startup]</div>
      </div>
      <div class="tree-group">Bloques de funciÃ³n</div>
      <div class="tree-item" id="tree-FB1" onclick="openTab('fb1','FB1 Motor')">
        <div class="icon">ðŸ”²</div><div class="tree-label">FB1 [Motor]</div>
      </div>
      <div class="tree-item" id="tree-FC1" onclick="openTab('fc1','FC1 CÃ¡lculos')">
        <div class="icon">â¬¡</div><div class="tree-label">FC1 [CÃ¡lculos]</div>
      </div>
      <div class="tree-group">Data Blocks</div>
      <div class="tree-item" id="tree-DB1" onclick="openTab('db1','DB1 Motor_DB')">
        <div class="icon">ðŸ—„</div><div class="tree-label">DB1 [Motor_DB]</div>
      </div>
      <div class="tree-item" onclick="openTab('db2','DB2 Global_DB')">
        <div class="icon">ðŸ—„</div><div class="tree-label">DB2 [Global_DB]</div>
      </div>
      <div class="tree-group">Hardware</div>
      <div class="tree-item">
        <div class="icon">ðŸ”Œ</div><div class="tree-label">ConfiguraciÃ³n HW</div>
      </div>
      <div class="tree-item">
        <div class="icon">ðŸ“¡</div><div class="tree-label">PROFINET IO</div>
      </div>
      <div class="tree-group">Tabla de Variables</div>
      <div class="tree-item" onclick="openRightTab('io','Tabla I/O')">
        <div class="icon">ðŸ“Š</div><div class="tree-label">Tabla PLC</div>
      </div>
    </div>

    <!-- Blocks palette -->
    <div class="sidebar-content" id="sideBlocks" style="display:none">
      <div class="tree-group">Contactos</div>
      <div class="block-palette">
        <div class="palette-item" draggable="true" data-type="NO">
          <div class="palette-color" style="background:var(--accent)"></div>â€”| |â€” Contacto NA
        </div>
        <div class="palette-item" draggable="true" data-type="NC">
          <div class="palette-color" style="background:var(--orange)"></div>â€”|/|â€” Contacto NC
        </div>
        <div class="palette-item" draggable="true" data-type="P">
          <div class="palette-color" style="background:var(--purple)"></div>â€”|P|â€” Flanco â†‘
        </div>
        <div class="palette-item" draggable="true" data-type="N">
          <div class="palette-color" style="background:var(--purple)"></div>â€”|N|â€” Flanco â†“
        </div>
      </div>
      <div class="tree-group">Bobinas</div>
      <div class="block-palette">
        <div class="palette-item" draggable="true" data-type="COIL">
          <div class="palette-color" style="background:var(--green)"></div>â€”( )â€” Bobina
        </div>
        <div class="palette-item" draggable="true" data-type="SET">
          <div class="palette-color" style="background:var(--accent)"></div>â€”(S)â€” Set
        </div>
        <div class="palette-item" draggable="true" data-type="RESET">
          <div class="palette-color" style="background:var(--red)"></div>â€”(R)â€” Reset
        </div>
      </div>
      <div class="tree-group">Bloques</div>
      <div class="block-palette">
        <div class="palette-item" draggable="true" data-type="TON">
          <div class="palette-color" style="background:var(--siemens)"></div>TON Temporizador ON
        </div>
        <div class="palette-item" draggable="true" data-type="TOF">
          <div class="palette-color" style="background:var(--siemens)"></div>TOF Temporizador OFF
        </div>
        <div class="palette-item" draggable="true" data-type="CTU">
          <div class="palette-color" style="background:var(--yellow)"></div>CTU Contador UP
        </div>
        <div class="palette-item" draggable="true" data-type="MOVE">
          <div class="palette-color" style="background:var(--purple)"></div>MOVE Transferencia
        </div>
        <div class="palette-item" draggable="true" data-type="ADD">
          <div class="palette-color" style="background:var(--orange)"></div>ADD Suma
        </div>
        <div class="palette-item" draggable="true" data-type="CMP">
          <div class="palette-color" style="background:var(--yellow)"></div>CMP Comparador
        </div>
      </div>
    </div>

    <!-- Library -->
    <div class="sidebar-content" id="sideLibrary" style="display:none">
      <div class="tree-group">LibrerÃ­a de usuario</div>
      <div class="tree-item"><div class="icon">ðŸ“¦</div><div class="tree-label">Control_Motor</div></div>
      <div class="tree-item tree-indent"><div class="icon">ðŸ”²</div><div class="tree-label">FB_MotorControl</div></div>
      <div class="tree-item tree-indent"><div class="icon">ðŸ—„</div><div class="tree-label">DB_MotorType</div></div>
      <div class="tree-group">LibrerÃ­a global</div>
      <div class="tree-item"><div class="icon">ðŸ“¦</div><div class="tree-label">Siemens</div></div>
    </div>
  </div>

  <!-- EDITOR -->
  <div class="editor-area">
    <div class="editor-tabs" id="editorTabs">
      <div class="editor-tab active" data-tab="main">
        <span>OB1 Main</span><span class="close-tab" onclick="closeTab('main')">Ã—</span>
      </div>
    </div>

    <div class="ladder-canvas" id="ladderCanvas" oncontextmenu="showContextMenu(event)">
      <!-- Networks renderizadas por JS -->
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">
    <div class="rpanel-tabs">
      <button class="rpanel-tab active" id="rtab-io" onclick="openRightTab('io',this)">I/O</button>
      <button class="rpanel-tab" id="rtab-db" onclick="openRightTab('db',this)">DB/Vars</button>
      <button class="rpanel-tab" id="rtab-diag" onclick="openRightTab('diag',this)">Diag</button>
    </div>
    <div class="rpanel-content" id="rpanel-io">
      <table class="io-table">
        <thead><tr><th>Addr.</th><th>Nombre</th><th>Estado</th><th>F</th></tr></thead>
        <tbody id="ioTableBody"></tbody>
      </table>
    </div>
    <div class="rpanel-content" id="rpanel-db" style="display:none">
      <div id="dbContent"></div>
    </div>
    <div class="rpanel-content" id="rpanel-diag" style="display:none">
      <div style="padding:10px">
        <div class="tree-group">Estado CPU</div>
        <div class="db-row"><span style="color:var(--text3);font-size:11px">Modo operaciÃ³n</span><span id="diagMode" class="db-val">STOP</span></div>
        <div class="db-row"><span style="color:var(--text3);font-size:11px">Ciclos totales</span><span id="diagCycles" class="db-val">0</span></div>
        <div class="db-row"><span style="color:var(--text3);font-size:11px">Tiempo ciclo mÃ¡x.</span><span id="diagMaxCycle" class="db-val">0 ms</span></div>
        <div class="db-row"><span style="color:var(--text3);font-size:11px">Tiempo ciclo mÃ­n.</span><span id="diagMinCycle" class="db-val">0 ms</span></div>
        <div class="db-row"><span style="color:var(--text3);font-size:11px">Mem. carga</span><span class="db-val">1.2 MB</span></div>
        <div class="db-row"><span style="color:var(--text3);font-size:11px">Mem. trabajo</span><span class="db-val">384 KB</span></div>
        <div class="tree-group" style="margin-top:8px">Buffer de diagnÃ³stico</div>
        <div id="diagBuffer" style="padding:4px 8px;font-size:10px;font-family:'Share Tech Mono',monospace;color:var(--text3)">Sin eventos</div>
      </div>
    </div>
  </div>
</div>

<!-- BOTTOM PANEL -->
<div class="bottom-panel">
  <div class="bottom-tabs">
    <button class="bottom-tab active" onclick="showBottomTab('log',this)">Log de compilaciÃ³n</button>
    <button class="bottom-tab" onclick="showBottomTab('crossref',this)">Referencias cruzadas</button>
    <button class="bottom-tab" onclick="showBottomTab('watch',this)">Tabla Watch</button>
  </div>
  <div class="log-content" id="logPanel"></div>
  <div class="log-content" id="crossrefPanel" style="display:none">
    <table style="width:100%;font-size:10px;font-family:'Share Tech Mono',monospace;border-collapse:collapse">
      <tr style="color:var(--text3)"><th style="text-align:left;padding:2px 6px">Variable</th><th>Tipo</th><th>Usada en</th><th>Rung</th></tr>
      <tr><td style="padding:2px 6px;color:var(--accent)">I0.0</td><td style="color:var(--text2)">BOOL</td><td style="color:var(--text2)">OB1</td><td style="color:var(--text3)">N1R1, N3R1</td></tr>
      <tr><td style="padding:2px 6px;color:var(--accent)">I0.1</td><td style="color:var(--text2)">BOOL</td><td style="color:var(--text2)">OB1</td><td style="color:var(--text3)">N1R1</td></tr>
      <tr><td style="padding:2px 6px;color:var(--green)">Q0.0</td><td style="color:var(--text2)">BOOL</td><td style="color:var(--text2)">OB1</td><td style="color:var(--text3)">N1R1</td></tr>
      <tr><td style="padding:2px 6px;color:var(--green)">Q0.1</td><td style="color:var(--text2)">BOOL</td><td style="color:var(--text2)">OB1</td><td style="color:var(--text3)">N2R1</td></tr>
    </table>
  </div>
  <div class="log-content" id="watchPanel" style="display:none">
    <table style="width:100%;font-size:10px;font-family:'Share Tech Mono',monospace;border-collapse:collapse">
      <thead><tr style="color:var(--text3)"><th style="text-align:left;padding:2px 6px">DirecciÃ³n</th><th>Nombre</th><th>Tipo</th><th>Valor monitor</th></tr></thead>
      <tbody id="watchBody"></tbody>
    </table>
  </div>
</div>

<!-- HMI PANEL -->
<div class="hmi-overlay" id="hmiOverlay">
  <div class="hmi-window" id="hmiWindow">
    <div class="hmi-titlebar" id="hmiTitlebar">
      <div class="hmi-title-icon">HMI</div>
      <div class="hmi-title-text">Panel de Control â€” Runtime Simulator</div>
      <div style="font-size:10px;color:var(--text3);margin-right:8px" id="hmiPlcState">PLC: STOP</div>
      <div class="hmi-titlebar-btns">
        <button class="hmi-tb-btn" onclick="clearHMI()" title="Limpiar panel">ðŸ—‘</button>
        <button class="hmi-tb-btn red" onclick="closeHMI()" title="Cerrar">âœ•</button>
      </div>
    </div>
    <div class="hmi-toolbar">
      <span style="font-size:10px;color:var(--text3);margin-right:4px">Agregar:</span>
      <button class="hmi-tool" onclick="addHMIWidget('pushbtn','green')" title="BotÃ³n pulsador momentÃ¡neo (NA)">ðŸ”˜ PushBtn NA</button>
      <button class="hmi-tool" onclick="addHMIWidget('pushbtn-nc','red')" title="BotÃ³n pulsador momentÃ¡neo (NC)">ðŸ”´ PushBtn NC</button>
      <button class="hmi-tool" onclick="addHMIWidget('switch')" title="Switch selector de 2 pos">ðŸ”² Switch</button>
      <div style="width:1px;height:20px;background:var(--border);margin:0 4px"></div>
      <button class="hmi-tool" onclick="addHMIWidget('light-green')" title="Foco piloto verde">ðŸŸ¢ Foco Verde</button>
      <button class="hmi-tool" onclick="addHMIWidget('light-red')" title="Foco piloto rojo">ðŸ”´ Foco Rojo</button>
      <button class="hmi-tool" onclick="addHMIWidget('light-yellow')" title="Foco piloto amarillo">ðŸŸ¡ Foco Amarillo</button>
      <button class="hmi-tool" onclick="addHMIWidget('light-blue')" title="Foco piloto azul">ðŸ”µ Foco Azul</button>
      <div style="width:1px;height:20px;background:var(--border);margin:0 4px"></div>
      <button class="hmi-tool" onclick="addHMIWidget('motor')" title="Motor elÃ©ctrico">âš™ Motor</button>
      <button class="hmi-tool" onclick="addHMIWidget('conveyor')" title="Banda transportadora">ðŸ“¦ Conveyor</button>
      <button class="hmi-tool" onclick="addHMIWidget('valve')" title="VÃ¡lvula solenoide">âŠ— VÃ¡lvula</button>
      <button class="hmi-tool" onclick="addHMIWidget('gauge')" title="Indicador analÃ³gico">ðŸ“Š Gauge</button>
    </div>
    <div class="hmi-body">
      <div class="hmi-canvas" id="hmiCanvas" onclick="deselectHMI(event)">
        <div class="hmi-canvas-inner" id="hmiCanvasInner"></div>
        <div class="hmi-grid-label">PANEL HMI â€” arrastra widgets â€¢ clic para configurar</div>
      </div>
      <div class="hmi-props" id="hmiProps">
        <div class="hmi-props-title">Propiedades</div>
        <div id="hmiPropsContent">
          <div style="padding:16px 12px;font-size:11px;color:var(--text3);text-align:center;line-height:1.6">
            Selecciona un widget<br>para editar sus propiedades
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FORCE MODAL -->
<div class="modal-overlay" id="forceModal">
  <div class="modal">
    <div class="modal-header">
      <span>âš  Forzado de seÃ±ales â€” Modo Online</span>
      <button class="close" onclick="closeForceModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <p style="font-size:11px;color:var(--yellow);margin-bottom:12px">âš  El forzado anula la lÃ³gica del programa. Ãšselo solo para diagnÃ³stico.</p>
      <table class="modal-force-table" id="forceTable">
        <thead><tr><th>DirecciÃ³n</th><th>Nombre</th><th>Valor forzado</th><th>Activar</th></tr></thead>
        <tbody id="forceTableBody"></tbody>
      </table>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button class="tb-btn stop-btn" onclick="clearForces();closeForceModal()">Borrar todos</button>
        <button class="tb-btn sim-btn" onclick="closeForceModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- CONTEXT MENU -->
<div class="context-menu" id="contextMenu">
  <div class="ctx-item" onclick="addRungToCurrentNetwork()"><div class="ctx-icon">âž•</div>AÃ±adir rung</div>
  <div class="ctx-item" onclick="addNetwork()"><div class="ctx-icon">ðŸ”³</div>AÃ±adir network</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="ctxAddElement('NO')"><div class="ctx-icon">â€”| |â€”</div>Contacto NA</div>
  <div class="ctx-item" onclick="ctxAddElement('NC')"><div class="ctx-icon">â€”|/|â€”</div>Contacto NC</div>
  <div class="ctx-item" onclick="ctxAddElement('COIL')"><div class="ctx-icon">â€”( )â€”</div>Bobina</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="ctxAddElement('TON')"><div class="ctx-icon">â±</div>Temporizador TON</div>
  <div class="ctx-item" onclick="ctxAddElement('CTU')"><div class="ctx-icon">ðŸ”¢</div>Contador CTU</div>
  <div class="ctx-item" onclick="ctxAddElement('MOVE')"><div class="ctx-icon">âž¡</div>MOVE</div>
  <div class="ctx-item" onclick="ctxAddElement('ADD')"><div class="ctx-icon">âž•</div>ADD</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="deleteSelectedRung()"><div class="ctx-icon" style="color:var(--red)">ðŸ—‘</div>Borrar rung</div>
</div>

<script>
// ================================================================
// PLC SIMULATOR â€” CORE ENGINE
// ================================================================
const state = {
  running: false,
  simOnline: false,
  scanCycle: 0,
  scanTime: 0,
  maxScan: 0, minScan: 9999,
  timer: null,
  selectedRung: null,
  selectedNetwork: 0,
  openTabs: ['main'],
  activeTab: 'main',
};

// Signal memory
const signals = {};   // key: "I0.0", value: { val: bool, forced: bool, forcedVal: bool, name: str, type: 'I'|'Q'|'M' }
const dbVars = {
  'DB1': [
    { name: 'Motor_On', type: 'BOOL', val: false },
    { name: 'Motor_Speed', type: 'INT', val: 0 },
    { name: 'Motor_Current', type: 'REAL', val: 0.0 },
    { name: 'Run_Hours', type: 'INT', val: 1247 },
  ],
  'DB2': [
    { name: 'Counter_Val', type: 'INT', val: 0 },
    { name: 'Set_Point', type: 'REAL', val: 100.0 },
    { name: 'Alarm_Active', type: 'BOOL', val: false },
    { name: 'Mode_Word', type: 'WORD', val: 0x0001 },
  ]
};

// Default I/O signals
const defaultSignals = [
  { addr: 'I0.0', name: 'Start_PB', type: 'I' },
  { addr: 'I0.1', name: 'Stop_PB', type: 'I' },
  { addr: 'I0.2', name: 'Emergency_Stop', type: 'I' },
  { addr: 'I0.3', name: 'Sensor_Lim1', type: 'I' },
  { addr: 'I0.4', name: 'Sensor_Lim2', type: 'I' },
  { addr: 'I0.5', name: 'Fault_FB', type: 'I' },
  { addr: 'I1.0', name: 'Mode_Auto', type: 'I' },
  { addr: 'I1.1', name: 'Mode_Manual', type: 'I' },
  { addr: 'Q0.0', name: 'Motor_Run', type: 'Q' },
  { addr: 'Q0.1', name: 'Conveyor_Fwd', type: 'Q' },
  { addr: 'Q0.2', name: 'Alarm_Horn', type: 'Q' },
  { addr: 'Q0.3', name: 'Lamp_Run', type: 'Q' },
  { addr: 'Q0.4', name: 'Lamp_Fault', type: 'Q' },
  { addr: 'Q1.0', name: 'Valve_1', type: 'Q' },
  { addr: 'Q1.1', name: 'Valve_2', type: 'Q' },
  { addr: 'M0.0', name: 'Motor_Latch', type: 'M' },
  { addr: 'M0.1', name: 'Fault_Mem', type: 'M' },
  { addr: 'M0.2', name: 'Cycle_Bit', type: 'M' },
  { addr: 'M10.0', name: 'AlwaysON', type: 'M' },
];
defaultSignals.forEach(s => {
  signals[s.addr] = { val: s.addr === 'M10.0', forced: false, forcedVal: false, name: s.name, type: s.type };
});

// ================================================================
// LADDER PROGRAM DEFINITION
// ================================================================
// networks: array of { title, comment, rungs: [{ elements: [...] }] }
let networks = [
  {
    title: 'Network 1', comment: 'Control arranque motor (enclavamiento)',
    rungs: [
      {
        // Rung principal: Start + NC Stop + NC Estop â†’ Motor_Run
        // El contacto M0.0 es el latch en paralelo con Start (I0.0)
        elements: [
          { type: 'NO', addr: 'I0.0', label: 'Start_PB' },
          { type: 'NC', addr: 'I0.1', label: 'Stop_PB' },
          { type: 'NC', addr: 'I0.2', label: 'E_Stop' },
          { type: 'COIL', addr: 'Q0.0', label: 'Motor_Run' },
        ],
        // Rama paralela (latch): en paralelo con I0.0
        latch: { addr: 'M0.0', label: 'Motor_Latch', parallelWith: 0 }
      },
      {
        // Rung 2: Q0.0 activo â†’ setea M0.0 (la memoria de enclavamiento)
        elements: [
          { type: 'NO', addr: 'Q0.0', label: 'Motor_Run' },
          { type: 'COIL', addr: 'M0.0', label: 'Motor_Latch' },
        ]
      },
    ]
  },
  {
    title: 'Network 2', comment: 'SeÃ±al de marcha y lÃ¡mpara',
    rungs: [
      { elements: [
        { type: 'NO', addr: 'Q0.0', label: 'Motor_Run' },
        { type: 'NO', addr: 'I1.0', label: 'Mode_Auto' },
        { type: 'COIL', addr: 'Q0.1', label: 'Conveyor' },
      ]},
    ]
  },
  {
    title: 'Network 3', comment: 'FB1 Control Motor',
    rungs: [
      { elements: [
        { type: 'NO', addr: 'I0.0', label: 'Start' },
        { type: 'FB', name: 'FB1', instance: 'DB1', pins: { IN: ['EN','Start','Stop'], OUT: ['Running','Fault'] }, addr: '' },
        { type: 'COIL', addr: 'Q0.3', label: 'Lamp_Run' },
      ]},
    ]
  },
  {
    title: 'Network 4', comment: 'Temporizador TON',
    rungs: [
      { elements: [
        { type: 'NO', addr: 'Q0.0', label: 'Motor_Run' },
        { type: 'TON', name: 'TON', instance: 'IEC_Timer_0_DB', pt: '5s', addr: '' },
        { type: 'COIL', addr: 'Q0.2', label: 'Alarm_Horn' },
      ]},
    ]
  },
];

// timer states
const timerStates = {};
const counterStates = {};

// ================================================================
// RENDER LADDER
// ================================================================
function getSignalVal(addr) {
  if (!signals[addr]) return false;
  const s = signals[addr];
  return s.forced ? s.forcedVal : s.val;
}

function setSignalVal(addr, val) {
  if (!signals[addr]) return;
  if (!signals[addr].forced) signals[addr].val = val;
}

function renderLadder() {
  const canvas = document.getElementById('ladderCanvas');
  canvas.innerHTML = '';

  networks.forEach((net, ni) => {
    const netDiv = document.createElement('div');
    netDiv.className = 'network-block';
    netDiv.id = 'net-' + ni;

    const header = document.createElement('div');
    header.className = 'network-header';
    header.innerHTML = `
      <span class="network-num">${String(ni+1).padStart(3,'0')}</span>
      <span class="network-title" contenteditable="true" onblur="networks[${ni}].title=this.innerText">${net.title}</span>
      <span class="network-comment" contenteditable="true" onblur="networks[${ni}].comment=this.innerText">${net.comment || ''}</span>
      <button class="tb-btn" style="margin-left:8px;font-size:9px" onclick="deleteNetwork(${ni})">âœ•</button>
      <button class="tb-btn" style="font-size:9px" onclick="addRungToNetwork(${ni})">+ Rung</button>
    `;
    netDiv.appendChild(header);

    const body = document.createElement('div');
    body.style.padding = '8px 12px';

    net.rungs.forEach((rung, ri) => {
      const rungDiv = renderRung(rung, ni, ri);
      body.appendChild(rungDiv);
    });

    const addBtn = document.createElement('button');
    addBtn.className = 'add-rung-btn';
    addBtn.innerHTML = '+ AÃ±adir rung';
    addBtn.onclick = () => addRungToNetwork(ni);
    body.appendChild(addBtn);

    netDiv.appendChild(body);
    canvas.appendChild(netDiv);
  });

  const addNetBtn = document.createElement('button');
  addNetBtn.className = 'add-rung-btn';
  addNetBtn.innerHTML = '+ AÃ±adir Network';
  addNetBtn.style.margin = '8px 0';
  addNetBtn.onclick = addNetwork;
  canvas.appendChild(addNetBtn);
}

function renderRung(rung, ni, ri) {
  const rungDiv = document.createElement('div');
  rungDiv.className = 'ladder-rung';
  rungDiv.id = `rung-${ni}-${ri}`;
  rungDiv.onclick = (e) => { e.stopPropagation(); selectRung(ni, ri); };
  rungDiv.style.alignItems = 'stretch';

  const numDiv = document.createElement('div');
  numDiv.className = 'rung-number';
  numDiv.textContent = ri + 1;
  numDiv.style.paddingTop = '20px';
  rungDiv.appendChild(numDiv);

  // Calcular flujo de poder (sin escribir)
  let mainPower = true;
  for (const el of rung.elements) {
    if (el.type === 'NO' || el.type === 'P') mainPower = mainPower && getSignalVal(el.addr);
    else if (el.type === 'NC' || el.type === 'N') mainPower = mainPower && !getSignalVal(el.addr);
    else if (el.type === 'TON' || el.type === 'TOF') {
      const t = timerStates[el.instance || 'ton_default'] || { q: false };
      mainPower = mainPower && t.q;
    } else if (el.type === 'CTU') {
      const c = counterStates[el.instance || 'ctu_default'] || { q: false };
      mainPower = mainPower && c.q;
    }
  }

  const latchPower = rung.latch ? getSignalVal(rung.latch.addr) : false;
  const energized = mainPower || latchPower;

  const bodyDiv = document.createElement('div');
  bodyDiv.className = 'rung-body' + (energized ? ' energized' : '');
  bodyDiv.style.flexDirection = 'column';
  bodyDiv.style.padding = '0';
  bodyDiv.style.overflow = 'visible';
  bodyDiv.style.position = 'relative';

  if (!rung.latch) {
    // â”€â”€ Rung normal (sin rama paralela) â”€â”€
    bodyDiv.style.flexDirection = 'row';
    bodyDiv.style.alignItems = 'center';
    bodyDiv.style.padding = '0 8px';
    bodyDiv.style.minHeight = '60px';

    const powerline = document.createElement('div');
    powerline.className = 'rung-powerline';
    bodyDiv.appendChild(powerline);

    rung.elements.forEach((el, ei) => {
      bodyDiv.appendChild(renderElement(el, ni, ri, ei, energized));
    });

    const delBtn = document.createElement('button');
    delBtn.className = 'tb-btn';
    delBtn.style.cssText = 'margin-left:8px;font-size:9px;position:relative;z-index:2;flex-shrink:0';
    delBtn.textContent = 'âœ•';
    delBtn.onclick = (e) => { e.stopPropagation(); deleteRung(ni, ri); };
    bodyDiv.appendChild(delBtn);

  } else {
    // â”€â”€ Rung con rama paralela (latch) â”€â”€
    // DiseÃ±o:
    //   â”Œâ”€[Start_PB I0.0]â”€â”¬â”€[Stop_NC]â”€[EStop_NC]â”€( Motor_Run )â”€â”
    //   â””â”€[Latch M0.0   ]â”€â”˜
    //
    // Left vertical + top row + bottom row + right vertical

    bodyDiv.style.position = 'relative';
    bodyDiv.style.minHeight = '110px';

    const latchOn = latchPower;
    const mainOn  = mainPower;
    const anyOn   = energized;

    const lineColor = (on) => on ? 'var(--green)' : 'var(--border2)';
    const lineShadow = (on) => on ? '0 0 6px var(--green)' : 'none';

    // â”€â”€â”€ Build layout with SVG-like lines using divs â”€â”€â”€
    const layout = document.createElement('div');
    layout.style.cssText = 'display:flex;flex-direction:column;width:100%;padding:6px 8px;gap:0;position:relative;';

    // TOP ROW: left-vert + first contact + junction + rest of contacts + coil + delete
    const topRow = document.createElement('div');
    topRow.style.cssText = 'display:flex;align-items:center;min-height:58px;position:relative;';

    // Left vertical bar (top half) â€” connects to latch row below
    const leftVertTop = document.createElement('div');
    leftVertTop.style.cssText = `width:2px;height:100%;background:${lineColor(anyOn)};flex-shrink:0;border-radius:2px;box-shadow:${lineShadow(anyOn)};transition:background 0.2s,box-shadow 0.2s;margin-right:0;align-self:stretch;`;

    // Horizontal lead from left-vert to first contact
    const hLead1 = document.createElement('div');
    hLead1.style.cssText = `height:2px;width:6px;background:${lineColor(mainOn||latchOn)};flex-shrink:0;box-shadow:${lineShadow(mainOn||latchOn)};transition:background 0.2s;`;

    // First contact (Start_PB â€” parallel origin)
    const firstEl = rung.elements[0];
    const firstElDiv = renderElement(firstEl, ni, ri, 0, mainOn);

    // Junction vertical (right side of first contact, to meet latch branch)
    const junctionVert = document.createElement('div');
    junctionVert.style.cssText = `width:2px;background:${lineColor(anyOn)};flex-shrink:0;align-self:stretch;box-shadow:${lineShadow(anyOn)};transition:background 0.2s;`;

    // Horizontal from junction to rest of contacts
    const hLead2 = document.createElement('div');
    hLead2.style.cssText = `height:2px;width:6px;background:${lineColor(mainOn)};flex-shrink:0;box-shadow:${lineShadow(mainOn)};transition:background 0.2s;`;

    topRow.appendChild(leftVertTop);
    topRow.appendChild(hLead1);
    topRow.appendChild(firstElDiv);
    topRow.appendChild(junctionVert);
    topRow.appendChild(hLead2);

    // Rest of contacts (index 1 .. n-1) and coil (last)
    for (let ei = 1; ei < rung.elements.length; ei++) {
      const el = rung.elements[ei];
      const elEnergized = ei < rung.elements.length - 1 ? mainOn : energized;
      topRow.appendChild(renderElement(el, ni, ri, ei, elEnergized));
    }

    const delBtn = document.createElement('button');
    delBtn.className = 'tb-btn';
    delBtn.style.cssText = 'margin-left:auto;font-size:9px;position:relative;z-index:2;flex-shrink:0;';
    delBtn.textContent = 'âœ•';
    delBtn.onclick = (e) => { e.stopPropagation(); deleteRung(ni, ri); };
    topRow.appendChild(delBtn);

    // BOTTOM ROW: left-vert-bottom + latch contact + right-lead closing back to junction
    const bottomRow = document.createElement('div');
    bottomRow.style.cssText = 'display:flex;align-items:center;min-height:46px;';

    const leftVertBottom = document.createElement('div');
    leftVertBottom.style.cssText = `width:2px;height:100%;background:${lineColor(latchOn)};flex-shrink:0;border-radius:2px;box-shadow:${lineShadow(latchOn)};align-self:stretch;transition:background 0.2s;`;

    const hLatchLead1 = document.createElement('div');
    hLatchLead1.style.cssText = `height:2px;width:6px;background:${lineColor(latchOn)};flex-shrink:0;box-shadow:${lineShadow(latchOn)};transition:background 0.2s;`;

    // Latch contact element
    const latchEl = { type: 'NO', addr: rung.latch.addr, label: rung.latch.label };
    const latchElDiv = renderElement(latchEl, ni, ri, -1, latchOn);

    // Closing horizontal line from latch contact back to junctionVert
    const hLatchClose = document.createElement('div');
    hLatchClose.style.cssText = `height:2px;flex:1;background:${lineColor(latchOn)};box-shadow:${lineShadow(latchOn)};transition:background 0.2s;`;

    // Right vertical closing bar
    const rightVert = document.createElement('div');
    rightVert.style.cssText = `width:2px;background:${lineColor(anyOn)};flex-shrink:0;align-self:stretch;box-shadow:${lineShadow(anyOn)};transition:background 0.2s;margin-left:0;`;

    bottomRow.appendChild(leftVertBottom);
    bottomRow.appendChild(hLatchLead1);
    bottomRow.appendChild(latchElDiv);
    bottomRow.appendChild(hLatchClose);
    bottomRow.appendChild(rightVert);

    // Overhead powerline (invisible â€” kept for CSS class compat)
    const powerline = document.createElement('div');
    powerline.style.display = 'none';

    layout.appendChild(topRow);
    layout.appendChild(bottomRow);
    bodyDiv.appendChild(layout);
  }

  rungDiv.appendChild(bodyDiv);
  return rungDiv;
}

// ----------------------------------------------------------------
// executeRung: ESCRIBE seÃ±ales en memoria â€” llamar solo desde plcScan
// ----------------------------------------------------------------
function executeRung(rung) {
  let power = false;

  // EvalÃºa rama principal (contactos en serie)
  // Si hay latch (rama paralela), el resultado es OR entre rama principal y latch
  let mainPower = true;
  let latchPower = false;

  for (const el of rung.elements) {
    if (el.type === 'NO' || el.type === 'P') {
      mainPower = mainPower && getSignalVal(el.addr);
    } else if (el.type === 'NC' || el.type === 'N') {
      mainPower = mainPower && !getSignalVal(el.addr);
    } else if (el.type === 'TON') {
      const key = el.instance || 'ton_default';
      if (!timerStates[key]) timerStates[key] = { acc: 0, q: false };
      const t = timerStates[key];
      const pt = parsePT(el.pt || '5s');
      if (mainPower) { t.acc = Math.min(t.acc + 100, pt); t.q = (t.acc >= pt); }
      else { t.acc = 0; t.q = false; }
      mainPower = mainPower && t.q;
    } else if (el.type === 'TOF') {
      const key = el.instance || 'tof_default';
      if (!timerStates[key]) timerStates[key] = { acc: 0, q: false };
      const t = timerStates[key];
      const pt = parsePT(el.pt || '5s');
      if (mainPower) { t.acc = 0; t.q = true; }
      else { t.acc = Math.min(t.acc + 100, pt); t.q = (t.acc < pt); }
      mainPower = t.q;
    } else if (el.type === 'CTU') {
      const key = el.instance || 'ctu_default';
      if (!counterStates[key]) counterStates[key] = { cv: 0, q: false, prevCU: false };
      const c = counterStates[key];
      const pv = el.pv || 10;
      if (mainPower && !c.prevCU) c.cv++;
      c.prevCU = mainPower;
      c.q = (c.cv >= pv);
      mainPower = c.q;
    }
  }

  // Si hay rama latch paralela con la primera serie
  if (rung.latch) {
    latchPower = getSignalVal(rung.latch.addr);
  }

  // OR de rama principal y latch
  power = mainPower || latchPower;

  // Escribir bobinas/salidas
  for (const el of rung.elements) {
    if (el.type === 'COIL') {
      if (el.addr) {
        if (!signals[el.addr]) signals[el.addr] = { val: false, forced: false, forcedVal: false, name: el.label||el.addr, type: (el.addr[0]||'Q').toUpperCase() };
        if (!signals[el.addr].forced) signals[el.addr].val = power;
      }
    } else if (el.type === 'SET') {
      if (power && el.addr) {
        if (!signals[el.addr]) signals[el.addr] = { val: false, forced: false, forcedVal: false, name: el.label||el.addr, type: (el.addr[0]||'M').toUpperCase() };
        if (!signals[el.addr].forced) signals[el.addr].val = true;
      }
    } else if (el.type === 'RESET') {
      if (power && el.addr) {
        if (!signals[el.addr]) signals[el.addr] = { val: false, forced: false, forcedVal: false, name: el.label||el.addr, type: (el.addr[0]||'M').toUpperCase() };
        if (!signals[el.addr].forced) signals[el.addr].val = false;
      }
    }
  }
  return power;
}

// ----------------------------------------------------------------
// evaluateRung: SOLO LEE seÃ±ales â€” para render visual (no escribe nada)
// ----------------------------------------------------------------
function evaluateRung(rung) {
  let power = true;
  let coilAddr = null;

  for (const el of rung.elements) {
    if (el.type === 'NO' || el.type === 'P') {
      power = power && getSignalVal(el.addr);
    } else if (el.type === 'NC' || el.type === 'N') {
      power = power && !getSignalVal(el.addr);
    } else if (el.type === 'COIL' || el.type === 'SET' || el.type === 'RESET') {
      coilAddr = el.addr;
      // NO escribir â€” solo reportar valor actual para el color visual
    } else if (el.type === 'TON' || el.type === 'TOF') {
      const key = el.instance || 'ton_default';
      const t = timerStates[key] || { acc: 0, q: false };
      power = power && t.q;
    } else if (el.type === 'CTU') {
      const key = el.instance || 'ctu_default';
      const c = counterStates[key] || { cv: 0, q: false };
      power = power && c.q;
    }
    // FB/MOVE/ADD/CMP: pass-through visual
  }
  return { energized: power, coilAddr };
}

function parsePT(str) {
  const match = str.match(/(\d+(\.\d+)?)(ms|s|m)/i);
  if (!match) return 5000;
  const v = parseFloat(match[1]);
  const u = match[3].toLowerCase();
  if (u === 'ms') return v;
  if (u === 's') return v * 1000;
  if (u === 'm') return v * 60000;
  return 5000;
}

function renderElement(el, ni, ri, ei, energized) {
  const wrap = document.createElement('div');
  wrap.className = 'ladder-el';

  if (el.type === 'NO' || el.type === 'NC' || el.type === 'P' || el.type === 'N') {
    const isActive = getSignalVal(el.addr);
    const label = document.createElement('div');
    label.className = 'el-label';
    label.textContent = el.label || el.addr;

    const body = document.createElement('div');
    body.className = 'el-body';
    body.title = el.addr;

    if (el.type === 'NO') {
      const bar1 = document.createElement('div'); bar1.style.cssText = 'width:10px;height:2px;background:'+(isActive?'var(--green)':'var(--border2)');
      const bars = document.createElement('div'); bars.className = 'contact-bar'; if(isActive) { bars.style.background='var(--green)'; bars.style.boxShadow='0 0 6px var(--green)'; }
      const bar2 = document.createElement('div'); bar2.style.cssText = 'width:10px;height:2px;background:'+(isActive?'var(--green)':'var(--border2)');
      body.appendChild(bar1); body.appendChild(bars); body.appendChild(bar2);
    } else if (el.type === 'NC') {
      const bar1 = document.createElement('div'); bar1.style.cssText = 'width:8px;height:2px;background:var(--border2)';
      const ncw = document.createElement('div'); ncw.style.cssText = 'position:relative;width:18px;height:28px;margin:0 2px';
      ncw.innerHTML = `<div style="position:absolute;left:3px;top:0;width:2px;height:28px;background:${isActive?'var(--green)':'var(--border2)'}"></div><div style="position:absolute;left:11px;top:0;width:2px;height:28px;background:${isActive?'var(--green)':'var(--border2)'}"></div><div style="position:absolute;width:20px;height:2px;background:var(--orange);top:50%;left:-2px;transform:rotate(-40deg)"></div>`;
      const bar2 = document.createElement('div'); bar2.style.cssText = 'width:8px;height:2px;background:var(--border2)';
      body.appendChild(bar1); body.appendChild(ncw); body.appendChild(bar2);
    } else {
      body.innerHTML = `<span style="font-size:10px;color:var(--purple);font-family:'Share Tech Mono',monospace">${el.type==='P'?'â†‘P':'â†“N'}</span>`;
    }

    body.onclick = (e) => { e.stopPropagation(); if(!state.running&&!state.simOnline) promptRename(el, ni, ri, ei); else toggleInput(el.addr); };

    const addr = document.createElement('div');
    addr.className = 'el-address';
    addr.style.color = isActive ? 'var(--green)' : 'var(--text3)';
    addr.textContent = el.addr;

    wrap.appendChild(label); wrap.appendChild(body); wrap.appendChild(addr);

  } else if (el.type === 'COIL' || el.type === 'SET' || el.type === 'RESET') {
    // Usar el valor real de la seÃ±al ya escrito por executeRung (no energized del render)
    const coilActive = getSignalVal(el.addr);
    const label = document.createElement('div');
    label.className = 'el-label';
    label.textContent = el.label || el.addr;

    const body = document.createElement('div');
    body.className = 'el-body';
    body.style.justifyContent = 'center';
    body.style.gap = '2px';
    const sym = el.type === 'COIL' ? 'Â·' : (el.type === 'SET' ? 'S' : 'R');
    body.innerHTML = `<div style="width:8px;height:2px;background:var(--border2)"></div><div class="coil-body${coilActive?' active':''}${el.type==='SET'?' set-coil':''}" style="${el.type==='RESET'?'border-color:var(--red);'+(coilActive?'background:rgba(255,61,0,0.1);color:var(--red);':''):''}">${sym}</div><div style="width:8px;height:2px;background:var(--border2)"></div>`;

    const addr = document.createElement('div');
    addr.className = 'el-address';
    addr.style.color = coilActive ? 'var(--green)' : 'var(--text3)';
    addr.textContent = el.addr;

    body.onclick = (e) => { e.stopPropagation(); if(!state.running) promptRename(el, ni, ri, ei); };
    wrap.appendChild(label); wrap.appendChild(body); wrap.appendChild(addr);

  } else if (el.type === 'FB') {
    const fb = document.createElement('div');
    fb.className = 'fb-block' + (energized ? ' active' : '');
    const inPins = el.pins ? el.pins.IN : ['IN1','IN2'];
    const outPins = el.pins ? el.pins.OUT : ['OUT1'];
    fb.innerHTML = `
      <div class="fb-title">${el.name} [${el.instance}]</div>
      <div class="fb-pins">
        <div class="fb-inputs">
          ${inPins.map(p => `<div class="fb-pin"><div class="fb-pin-dot${energized?' active':''}"></div>${p}</div>`).join('')}
        </div>
        <div style="width:1px;background:var(--border);margin:0 6px"></div>
        <div class="fb-outputs">
          ${outPins.map(p => `<div class="fb-pin"><div class="fb-pin-dot out${energized?' active':''}"></div>${p}</div>`).join('')}
        </div>
      </div>`;
    wrap.appendChild(fb);

  } else if (el.type === 'TON' || el.type === 'TOF') {
    const key = el.instance || 'ton_default';
    const t = timerStates[key] || { acc: 0, q: false };
    const pt = parsePT(el.pt || '5s');
    const pct = Math.min(100, (t.acc / pt) * 100);
    const fb = document.createElement('div');
    fb.className = 'fb-block' + (t.q ? ' active' : '');
    fb.innerHTML = `
      <div class="fb-title">${el.type} â€” ${el.instance}</div>
      <div class="fb-pins">
        <div class="fb-inputs">
          <div class="fb-pin"><div class="fb-pin-dot${energized?' active':''}"></div>IN</div>
          <div class="fb-pin"><div class="fb-pin-dot"></div>PT: ${el.pt}</div>
        </div>
        <div style="width:1px;background:var(--border);margin:0 6px"></div>
        <div class="fb-outputs">
          <div class="fb-pin"><div class="fb-pin-dot out${t.q?' active':''}"></div>Q</div>
          <div class="fb-pin"><div class="fb-pin-dot out"></div>ET: ${(t.acc/1000).toFixed(1)}s</div>
        </div>
      </div>
      <div style="margin-top:4px;height:4px;background:var(--bg4);border-radius:2px;overflow:hidden">
        <div style="height:100%;width:${pct}%;background:${t.q?'var(--green)':'var(--siemens)'};transition:width 0.1s"></div>
      </div>`;
    wrap.appendChild(fb);

  } else if (el.type === 'CTU') {
    const key = el.instance || 'ctu_default';
    const c = counterStates[key] || { cv: 0, q: false };
    const fb = document.createElement('div');
    fb.className = 'fb-block' + (energized ? ' active' : '');
    fb.innerHTML = `
      <div class="fb-title">CTU â€” ${el.instance||'CTU_0'}</div>
      <div class="fb-pins">
        <div class="fb-inputs">
          <div class="fb-pin"><div class="fb-pin-dot${energized?' active':''}"></div>CU</div>
          <div class="fb-pin"><div class="fb-pin-dot"></div>R</div>
          <div class="fb-pin"><div class="fb-pin-dot"></div>PV: ${el.pv||10}</div>
        </div>
        <div style="width:1px;background:var(--border);margin:0 6px"></div>
        <div class="fb-outputs">
          <div class="fb-pin"><div class="fb-pin-dot out${c.q?' active':''}"></div>Q</div>
          <div class="fb-pin"><div class="fb-pin-dot out"></div>CV: ${c.cv}</div>
        </div>
      </div>`;
    wrap.appendChild(fb);
  } else if (el.type === 'MOVE' || el.type === 'ADD' || el.type === 'CMP') {
    const icons = { MOVE:'â†’', ADD:'+', CMP:'â‰¥' };
    const fb = document.createElement('div');
    fb.className = 'fb-block' + (energized ? ' active' : '');
    fb.innerHTML = `
      <div class="fb-title">${el.type} ${icons[el.type]||''}</div>
      <div class="fb-pins">
        <div class="fb-inputs">
          <div class="fb-pin"><div class="fb-pin-dot${energized?' active':''}"></div>EN</div>
          <div class="fb-pin"><div class="fb-pin-dot"></div>IN: ${el.in1||'#MW0'}</div>
        </div>
        <div style="width:1px;background:var(--border);margin:0 6px"></div>
        <div class="fb-outputs">
          <div class="fb-pin"><div class="fb-pin-dot out${energized?' active':''}"></div>ENO</div>
          <div class="fb-pin"><div class="fb-pin-dot out"></div>OUT: ${el.out||'#MW2'}</div>
        </div>
      </div>`;
    wrap.appendChild(fb);
  }

  return wrap;
}

// ================================================================
// PLC SCAN CYCLE
// ================================================================
function plcScan() {
  const t0 = performance.now();

  // PASO 1: Reset SOLO bobinas normales (no SET/RESET, no forzadas)
  // igual que un PLC real: las salidas se ponen a 0 antes de cada scan
  networks.forEach(net => {
    net.rungs.forEach(rung => {
      rung.elements.forEach(el => {
        if (el.type === 'COIL' && el.addr && signals[el.addr] && !signals[el.addr].forced) {
          signals[el.addr].val = false;
        }
      });
    });
  });

  // PASO 2: Ejecutar TODOS los rungs en orden (lÃ³gica completa)
  networks.forEach(net => net.rungs.forEach(rung => executeRung(rung)));

  // M10.0 always ON
  if (signals['M10.0']) signals['M10.0'].val = true;

  const elapsed = performance.now() - t0;
  state.scanTime = elapsed + Math.random() * 0.5;
  state.maxScan = Math.max(state.maxScan, state.scanTime);
  state.minScan = Math.min(state.minScan, state.scanTime);
  state.scanCycle++;

  document.getElementById('scanTime').textContent = state.scanTime.toFixed(2);
  document.getElementById('errCount').textContent = '0';
  document.getElementById('diagCycles').textContent = state.scanCycle;
  document.getElementById('diagMaxCycle').textContent = state.maxScan.toFixed(2) + ' ms';
  document.getElementById('diagMinCycle').textContent = state.minScan.toFixed(2) + ' ms';

  renderLadder();
  updateIOTable();
  updateWatchTable();
  updateHMI();
}

// ================================================================
// PLC CONTROLS
// ================================================================
function startPLC() {
  state.running = true;
  state.simOnline = true;
  updateStatus('run');
  document.getElementById('simBtn').classList.add('active');
  state.timer = setInterval(plcScan, 100);
  addLog('ok', 'PLC', 'CPU 1516 â€” Modo RUN activado');
  addLog('info', 'SCAN', 'Ciclo de scan iniciado @ 100ms');
}

function stopPLC() {
  state.running = false;
  state.simOnline = false;
  updateStatus('stop');
  document.getElementById('simBtn').classList.remove('active');
  if (state.timer) { clearInterval(state.timer); state.timer = null; }
  addLog('warn', 'PLC', 'CPU 1516 â€” Modo STOP activado');
  renderLadder();
  updateIOTable();
}

function toggleSim() {
  if (!state.running) startPLC();
  else stopPLC();
}

function updateStatus(mode) {
  const badge = document.getElementById('plcStatus');
  badge.className = 'status-badge ' + mode;
  document.getElementById('statusText').textContent = mode.toUpperCase();
  document.getElementById('diagMode').textContent = mode.toUpperCase();
}

// ================================================================
// IO TABLE
// ================================================================
function updateIOTable() {
  const tbody = document.getElementById('ioTableBody');
  tbody.innerHTML = '';

  const sorted = Object.entries(signals).sort((a,b) => a[0].localeCompare(b[0]));
  sorted.forEach(([addr, sig]) => {
    const tr = document.createElement('tr');
    tr.className = `io-row ${sig.type === 'I' ? 'input' : sig.type === 'Q' ? 'output' : 'marker'}`;

    const typeClass = sig.type === 'I' ? 'on-I' : sig.type === 'Q' ? 'on-Q' : 'on-M';
    const isOn = sig.forced ? sig.forcedVal : sig.val;

    tr.innerHTML = `
      <td class="address-cell">${addr}</td>
      <td class="name-cell" style="max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${sig.name}">${sig.name}</td>
      <td><span class="signal-led ${isOn ? typeClass : ''}${sig.forced ? ' forced' : ''}" onclick="toggleSignalFromTable('${addr}')" title="${isOn?'TRUE':'FALSE'}${sig.forced?' [FORZADO]':''}"></span></td>
      <td><button class="force-btn-small${sig.forced ? ' active' : ''}" onclick="toggleForce('${addr}')" title="Forzar ${addr}">F</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function toggleSignalFromTable(addr) {
  if (!signals[addr]) return;
  if (signals[addr].forced) {
    signals[addr].forcedVal = !signals[addr].forcedVal;
  } else if (signals[addr].type === 'I') {
    signals[addr].val = !signals[addr].val;
  } else if (!state.running) {
    signals[addr].val = !signals[addr].val;
  }
  if (!state.running) { renderLadder(); updateIOTable(); }
}

function toggleInput(addr) {
  if (!signals[addr]) return;
  if (signals[addr].type === 'I' || !state.running) {
    signals[addr].val = !signals[addr].val;
    if (!state.running) { renderLadder(); updateIOTable(); }
  }
}

function toggleForce(addr) {
  if (!signals[addr]) return;
  signals[addr].forced = !signals[addr].forced;
  if (signals[addr].forced) {
    addLog('warn', 'FORCE', `SeÃ±al ${addr} (${signals[addr].name}) FORZADA a ${signals[addr].val ? 'TRUE' : 'FALSE'}`);
  } else {
    addLog('ok', 'FORCE', `Forzado eliminado de ${addr}`);
  }
  updateIOTable();
  renderForceModal();
}

function clearForces() {
  Object.keys(signals).forEach(k => { signals[k].forced = false; });
  addLog('ok', 'FORCE', 'Todos los forzados eliminados');
  updateIOTable();
  renderForceModal();
}

// ================================================================
// FORCE MODAL
// ================================================================
function openForceModal() {
  document.getElementById('forceModal').classList.add('open');
  renderForceModal();
}
function closeForceModal() {
  document.getElementById('forceModal').classList.remove('open');
}
function renderForceModal() {
  const tbody = document.getElementById('forceTableBody');
  tbody.innerHTML = '';
  Object.entries(signals).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([addr, sig]) => {
    const tr = document.createElement('tr');
    const isOn = sig.forced ? sig.forcedVal : sig.val;
    tr.innerHTML = `
      <td style="font-family:'Share Tech Mono',monospace;color:var(--accent);font-size:10px">${addr}</td>
      <td style="font-size:11px;color:var(--text2)">${sig.name}</td>
      <td>
        <label class="force-toggle" title="Valor forzado">
          <input type="checkbox" ${sig.forcedVal?'checked':''} onchange="signals['${addr}'].forcedVal=this.checked">
          <span class="force-slider"></span>
        </label>
      </td>
      <td>
        <label class="force-toggle">
          <input type="checkbox" ${sig.forced?'checked':''} onchange="toggleForce('${addr}')">
          <span class="force-slider"></span>
        </label>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ================================================================
// NETWORK / RUNG MANAGEMENT
// ================================================================
function addNetwork() {
  networks.push({ title: `Network ${networks.length+1}`, comment: 'Nuevo network', rungs: [{ elements: [] }] });
  renderLadder();
  addLog('info', 'EDIT', `Network ${networks.length} aÃ±adido`);
}

function deleteNetwork(ni) {
  if (networks.length <= 1) return;
  networks.splice(ni, 1);
  renderLadder();
}

function addRungToNetwork(ni) {
  networks[ni].rungs.push({ elements: [] });
  renderLadder();
}

function addRungToCurrentNetwork() {
  addRungToNetwork(state.selectedNetwork);
}

function deleteRung(ni, ri) {
  if (networks[ni].rungs.length <= 1) { networks[ni].rungs[ri].elements = []; }
  else networks[ni].rungs.splice(ri, 1);
  renderLadder();
}

function deleteSelectedRung() {
  const [ni, ri] = (state.selectedRung || '0-0').split('-').map(Number);
  deleteRung(ni, ri);
}

function selectRung(ni, ri) {
  state.selectedRung = `${ni}-${ri}`;
  state.selectedNetwork = ni;
}

function ctxAddElement(type) {
  if (state.selectedRung === null) state.selectedRung = '0-0';
  const [ni, ri] = state.selectedRung.split('-').map(Number);
  const defaults = {
    NO: { type:'NO', addr:'I0.0', label:'Signal' },
    NC: { type:'NC', addr:'I0.1', label:'Signal_NC' },
    COIL: { type:'COIL', addr:'Q0.0', label:'Output' },
    SET: { type:'SET', addr:'M0.0', label:'Set_bit' },
    RESET: { type:'RESET', addr:'M0.0', label:'Reset_bit' },
    TON: { type:'TON', name:'TON', instance:'IEC_Timer_'+Date.now(), pt:'5s' },
    CTU: { type:'CTU', name:'CTU', instance:'CTU_'+Date.now(), pv:10 },
    MOVE: { type:'MOVE', in1:'#IN', out:'#OUT' },
    ADD: { type:'ADD', in1:'#A', out:'#C' },
    CMP: { type:'CMP', in1:'#IN1', out:'#RES' },
  };
  const el = defaults[type] || { type, addr:'I0.0' };
  networks[ni].rungs[ri].elements.push(el);
  renderLadder();
  hideContextMenu();
}

// ================================================================
// TABS
// ================================================================
function openTab(id, name) {
  if (!state.openTabs.includes(id)) {
    state.openTabs.push(id);
    const tabs = document.getElementById('editorTabs');
    const tab = document.createElement('div');
    tab.className = 'editor-tab';
    tab.id = 'etab-' + id;
    tab.dataset.tab = id;
    tab.innerHTML = `<span>${name}</span><span class="close-tab" onclick="closeTab('${id}')">Ã—</span>`;
    tab.onclick = () => activateTab(id);
    tabs.appendChild(tab);
  }
  activateTab(id);
}

function activateTab(id) {
  state.activeTab = id;
  document.querySelectorAll('.editor-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === id));
  // For simplicity all tabs show same ladder, in real impl would switch views
}

function closeTab(id) {
  const idx = state.openTabs.indexOf(id);
  if (idx > -1) state.openTabs.splice(idx, 1);
  const el = document.getElementById('etab-' + id);
  if (el) el.remove();
  if (state.openTabs.length > 0) activateTab(state.openTabs[0]);
}

function showSideTab(tab, btn) {
  document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('sideProject').style.display = tab === 'project' ? '' : 'none';
  document.getElementById('sideBlocks').style.display = tab === 'blocks' ? '' : 'none';
  document.getElementById('sideLibrary').style.display = tab === 'library' ? '' : 'none';
}

function showBlocksTab(type) {
  showSideTab('blocks', document.querySelectorAll('.sidebar-tab')[1]);
}

function openRightTab(tab, el) {
  document.querySelectorAll('.rpanel-tab').forEach(t => t.classList.remove('active'));
  if (typeof el === 'string') document.getElementById('rtab-'+tab).classList.add('active');
  else el.classList.add('active');

  document.getElementById('rpanel-io').style.display = tab === 'io' ? '' : 'none';
  document.getElementById('rpanel-db').style.display = tab === 'db' ? '' : 'none';
  document.getElementById('rpanel-diag').style.display = tab === 'diag' ? '' : 'none';

  if (tab === 'db') renderDBPanel();
}

function renderDBPanel() {
  const c = document.getElementById('dbContent');
  c.innerHTML = '';
  Object.entries(dbVars).forEach(([dbName, vars]) => {
    const g = document.createElement('div');
    g.innerHTML = `<div class="tree-group">${dbName}</div>`;
    vars.forEach((v, vi) => {
      const row = document.createElement('div');
      row.className = 'db-row';
      const typeTag = `<span class="db-type-tag tag-${v.type}">${v.type}</span>`;
      const isEditable = v.type === 'INT' || v.type === 'REAL' || v.type === 'WORD';
      const valEl = isEditable
        ? `<input class="db-editable" type="number" value="${v.val}" onchange="dbVars['${dbName}'][${vi}].val=parseFloat(this.value)">`
        : `<label class="force-toggle" style="margin-left:auto"><input type="checkbox" ${v.val?'checked':''} onchange="dbVars['${dbName}'][${vi}].val=this.checked"><span class="force-slider"></span></label>`;
      row.innerHTML = `${typeTag}<span style="font-size:11px;color:var(--text)">${v.name}</span>${valEl}`;
      g.appendChild(row);
    });
    c.appendChild(g);
  });
}

function showBottomTab(tab, btn) {
  document.querySelectorAll('.bottom-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('logPanel').style.display = tab === 'log' ? '' : 'none';
  document.getElementById('crossrefPanel').style.display = tab === 'crossref' ? '' : 'none';
  document.getElementById('watchPanel').style.display = tab === 'watch' ? '' : 'none';
}

// ================================================================
// LOG
// ================================================================
let logCount = 0;
function addLog(type, tag, msg) {
  const panel = document.getElementById('logPanel');
  const line = document.createElement('div');
  line.className = `log-line ${type}`;
  const now = new Date();
  const ts = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}.${now.getMilliseconds().toString().padStart(3,'0')}`;
  line.innerHTML = `<span class="ts">${ts}</span><span class="tag">[${tag}]</span> ${msg}`;
  panel.appendChild(line);
  panel.scrollTop = panel.scrollHeight;
  if (++logCount > 100) panel.removeChild(panel.firstChild);
}

// ================================================================
// WATCH TABLE
// ================================================================
function updateWatchTable() {
  const tbody = document.getElementById('watchBody');
  tbody.innerHTML = '';
  const watch = ['I0.0','I0.1','Q0.0','Q0.1','M0.0','M10.0'];
  watch.forEach(addr => {
    if (!signals[addr]) return;
    const s = signals[addr];
    const val = s.forced ? s.forcedVal : s.val;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="color:var(--accent);padding:2px 6px">${addr}</td><td style="color:var(--text2)">${s.name}</td><td style="color:var(--text3)">BOOL</td><td style="color:${val?'var(--green)':'var(--text3)'}">${val?'TRUE':'FALSE'}</td>`;
    tbody.appendChild(tr);
  });
}

// ================================================================
// CONTEXT MENU
// ================================================================
function showContextMenu(e) {
  e.preventDefault();
  const menu = document.getElementById('contextMenu');
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';
  menu.classList.add('open');
}
function hideContextMenu() {
  document.getElementById('contextMenu').classList.remove('open');
}
document.addEventListener('click', hideContextMenu);

// ================================================================
// ADD IO
// ================================================================
function addNewIO(type) {
  const bits = Object.keys(signals).filter(k => k.startsWith(type)).length;
  const byte = Math.floor(bits / 8);
  const bit = bits % 8;
  const addr = `${type}${byte}.${bit}`;
  const name = prompt(`Nombre para ${addr}:`, `${type==='I'?'Input':type==='Q'?'Output':'Marker'}_${bits}`);
  if (!name) return;
  signals[addr] = { val: false, forced: false, forcedVal: false, name, type };
  updateIOTable();
  addLog('info', 'IO', `SeÃ±al ${addr} "${name}" aÃ±adida`);
}

// ================================================================
// COMPILE
// ================================================================
function compileAll() {
  addLog('info', 'COMP', 'Iniciando compilaciÃ³n...');
  setTimeout(() => {
    addLog('ok', 'COMP', 'OB1 compilado â€” 0 errores, 0 warnings');
    addLog('ok', 'COMP', 'FB1 compilado â€” 0 errores, 0 warnings');
    addLog('ok', 'COMP', 'FC1 compilado â€” 0 errores, 0 warnings');
    addLog('ok', 'COMP', `CompilaciÃ³n completada â€” ${networks.length} networks, ${networks.reduce((a,n)=>a+n.rungs.length,0)} rungs`);
  }, 300);
}

// ================================================================
// RENAME PROMPT
// ================================================================
function promptRename(el, ni, ri, ei) {
  const newAddr = prompt(`DirecciÃ³n de la seÃ±al:`, el.addr);
  if (!newAddr) return;
  const newLabel = prompt(`Etiqueta simbÃ³lica:`, el.label || '');
  networks[ni].rungs[ri].elements[ei].addr = newAddr.trim();
  networks[ni].rungs[ri].elements[ei].label = newLabel;
  if (!signals[newAddr.trim()]) {
    const type = newAddr[0];
    signals[newAddr.trim()] = { val: false, forced: false, forcedVal: false, name: newLabel||newAddr, type: type.toUpperCase() };
  }
  renderLadder();
  updateIOTable();
}

function showFileMenu() {
  addLog('info', 'PROJ', 'Proyecto: PLC_Simulator_v1.0 â€” guardado automÃ¡tico activado');
}

// ================================================================
// HMI PANEL ENGINE
// ================================================================
let hmiWidgets = [];
let hmiSelectedId = null;
let hmiDragState = null;
let hmiIdCounter = 0;

// Default widgets for demo
const defaultHMIWidgets = [
  { id:'hw1', type:'pushbtn',     color:'green',  x:40,  y:40,  label:'START',    addr:'I0.0', momentary:true  },
  { id:'hw2', type:'pushbtn-nc',  color:'red',    x:40,  y:140, label:'STOP',     addr:'I0.1', momentary:true  },
  { id:'hw3', type:'pushbtn-nc',  color:'red',    x:40,  y:240, label:'E-STOP',   addr:'I0.2', momentary:true  },
  { id:'hw4', type:'switch',      color:'',       x:40,  y:340, label:'MODE AUTO', addr:'I1.0', momentary:false },
  { id:'hw5', type:'light-green', color:'green',  x:200, y:40,  label:'MOTOR RUN', addr:'Q0.0' },
  { id:'hw6', type:'light-red',   color:'red',    x:200, y:140, label:'FAULT',     addr:'Q0.2' },
  { id:'hw7', type:'light-yellow',color:'yellow', x:200, y:240, label:'ALARM',     addr:'Q0.2' },
  { id:'hw8', type:'motor',       color:'',       x:360, y:40,  label:'MOTOR_M1',  addr:'Q0.0', faultAddr:'I0.5' },
  { id:'hw9', type:'conveyor',    color:'',       x:360, y:170, label:'CONVEYOR',  addr:'Q0.1' },
  { id:'hw10',type:'valve',       color:'',       x:560, y:40,  label:'VALVE_1',   addr:'Q1.0' },
  { id:'hw11',type:'valve',       color:'',       x:560, y:160, label:'VALVE_2',   addr:'Q1.1' },
];

function openHMI() {
  if (hmiWidgets.length === 0) {
    hmiWidgets = defaultHMIWidgets.map(w => ({...w}));
    hmiIdCounter = 20;
  }
  document.getElementById('hmiOverlay').classList.add('open');
  renderHMI();
  setupHMIDrag();
}

function closeHMI() {
  document.getElementById('hmiOverlay').classList.remove('open');
}

function clearHMI() {
  if (!confirm('Â¿Limpiar todos los widgets del panel?')) return;
  hmiWidgets = [];
  hmiSelectedId = null;
  renderHMI();
  renderHMIProps(null);
}

function addHMIWidget(type, color) {
  const id = 'hw' + (++hmiIdCounter);
  const defaults = {
    'pushbtn':      { label:'PB_START', addr:'I0.0', momentary:true },
    'pushbtn-nc':   { label:'PB_STOP',  addr:'I0.1', momentary:true },
    'switch':       { label:'SW_1',     addr:'I1.0', momentary:false },
    'light-green':  { label:'RUN',      addr:'Q0.0' },
    'light-red':    { label:'FAULT',    addr:'Q0.4' },
    'light-yellow': { label:'WARN',     addr:'Q0.2' },
    'light-blue':   { label:'READY',    addr:'Q0.3' },
    'motor':        { label:'MOTOR',    addr:'Q0.0', faultAddr:'I0.5' },
    'conveyor':     { label:'CONV',     addr:'Q0.1' },
    'valve':        { label:'VALVE',    addr:'Q1.0' },
    'gauge':        { label:'PRESS',    addr:'M10.0' },
  };
  const d = defaults[type] || {};
  const w = { id, type, color: color||'', x:80+Math.random()*200, y:80+Math.random()*150, label:d.label||'Widget', addr:d.addr||'I0.0', momentary:!!d.momentary, faultAddr: d.faultAddr||'' };
  hmiWidgets.push(w);
  renderHMI();
  selectHMIWidget(id);
}

function renderHMI() {
  const canvas = document.getElementById('hmiCanvasInner');
  canvas.innerHTML = '';

  // Update PLC state indicator
  const stateEl = document.getElementById('hmiPlcState');
  if (stateEl) stateEl.textContent = `PLC: ${state.running ? 'RUN â–¶' : 'STOP â– '}`;

  hmiWidgets.forEach(w => {
    const div = document.createElement('div');
    div.className = 'hmi-widget' + (w.id === hmiSelectedId ? ' selected' : '');
    div.id = 'hmiw-' + w.id;
    div.style.left = w.x + 'px';
    div.style.top  = w.y + 'px';
    div.dataset.id = w.id;

    const sigVal = getSignalVal(w.addr);
    const faultVal = w.faultAddr ? getSignalVal(w.faultAddr) : false;

    if (w.type === 'pushbtn' || w.type === 'pushbtn-nc') {
      const isNC = w.type === 'pushbtn-nc';
      const isPressed = sigVal;
      const colors = { green:'#00aa44', red:'#cc2200', yellow:'#cc8800', blue:'#0066cc', gray:'#555' };
      const btnColor = colors[w.color] || '#00aa44';
      div.innerHTML = `
        <div class="hmi-pb">
          <div class="hmi-pb-btn${isPressed?' pressed':''}" id="pbcore-${w.id}"
            style="background:radial-gradient(circle at 35% 30%, ${btnColor}cc, ${btnColor}88);box-shadow:0 5px 0 ${btnColor}44,inset 0 -3px 6px rgba(0,0,0,0.4),inset 0 2px 4px rgba(255,255,255,0.15)${isPressed?';filter:brightness(0.7)':''}"
            onmousedown="hmiPBDown('${w.id}')" onmouseup="hmiPBUp('${w.id}')" ontouchstart="hmiPBDown('${w.id}')" ontouchend="hmiPBUp('${w.id}')">
            ${isNC ? 'â­•' : ''}
          </div>
          <div class="hmi-pb-label">${w.label}<br><span style="color:var(--accent);font-size:8px">${w.addr}${isNC?' [NC]':''}</span></div>
        </div>`;

    } else if (w.type === 'switch') {
      div.innerHTML = `
        <div class="hmi-sw">
          <div class="hmi-sw-body${sigVal?' on':''}" onclick="hmiToggleSwitch('${w.id}')">
            <div class="hmi-sw-knob"></div>
          </div>
          <div class="hmi-sw-label">${w.label}<br><span style="color:var(--accent);font-size:8px">${w.addr}</span><br>
            <span style="color:${sigVal?'var(--green)':'var(--text3)'}">${sigVal?'ON':'OFF'}</span>
          </div>
        </div>`;

    } else if (w.type.startsWith('light-')) {
      const lightColors = { green:[sigVal?'#00ff66':'#003311',sigVal?'0 0 20px #00ff66,0 0 40px #00aa44':'none'],
                            red:  [sigVal?'#ff4400':'#330000',sigVal?'0 0 20px #ff4400,0 0 40px #cc2200':'none'],
                            yellow:[sigVal?'#ffcc00':'#332200',sigVal?'0 0 20px #ffcc00,0 0 40px #cc8800':'none'],
                            blue: [sigVal?'#00aaff':'#001133',sigVal?'0 0 20px #00aaff,0 0 40px #0066cc':'none'] };
      const lc = lightColors[w.color] || lightColors.green;
      div.innerHTML = `
        <div class="hmi-light">
          <div class="hmi-light-bulb${sigVal?' on':''}" style="background:radial-gradient(circle at 40% 35%, ${lc[0]}ff, ${lc[0]}88);box-shadow:${lc[1]};border-color:rgba(0,0,0,0.5)"></div>
          <div class="hmi-light-label">${w.label}<br><span style="color:var(--accent);font-size:8px">${w.addr}</span><br>
            <span style="color:${sigVal?'var(--green)':'var(--text3)'}">â—</span>
          </div>
        </div>`;

    } else if (w.type === 'motor') {
      const running = sigVal;
      const fault = faultVal;
      div.innerHTML = `
        <div class="hmi-motor">
          <div class="hmi-motor-body${running&&!fault?' running':''}${fault?' fault':''}">
            <div class="hmi-motor-rotor${running&&!fault?' spinning':''}"></div>
          </div>
          <div class="hmi-motor-label">${w.label}</div>
          <div class="hmi-motor-rpm" style="color:${running?'var(--green)':fault?'var(--red)':'var(--text3)'}">
            ${fault?'âš  FAULT':running?`${Math.round(1450+Math.random()*10)} RPM`:'â–  STOP'}
          </div>
        </div>`;

    } else if (w.type === 'conveyor') {
      const running = sigVal;
      div.innerHTML = `
        <div class="hmi-conveyor">
          <div class="hmi-conveyor-belt${running?' running':''}">
            <div class="hmi-conveyor-strip"></div>
          </div>
          <div class="hmi-motor-label">${w.label}</div>
          <div class="hmi-motor-rpm" style="color:${running?'var(--green)':'var(--text3)'}">${running?'â–¶ RUNNING':'â–  STOPPED'}</div>
        </div>`;

    } else if (w.type === 'valve') {
      const open = sigVal;
      div.innerHTML = `
        <div class="hmi-valve">
          <svg class="hmi-valve-svg" viewBox="0 0 50 44">
            <!-- Valve body -->
            <rect x="8" y="18" width="34" height="8" rx="2" fill="${open?'#004444':'#333'}" stroke="${open?'var(--siemens)':'#555'}" stroke-width="1.5"/>
            <!-- Left pipe -->
            <rect x="0" y="20" width="10" height="4" fill="#444"/>
            <!-- Right pipe -->
            <rect x="40" y="20" width="10" height="4" fill="#444"/>
            <!-- Actuator stem -->
            <rect x="23" y="4" width="4" height="14" rx="1" fill="${open?'var(--green)':'#555'}"/>
            <!-- Actuator body -->
            <rect x="16" y="0" width="18" height="8" rx="3" fill="${open?'#005500':'#333'}" stroke="${open?'var(--green)':'#444'}" stroke-width="1.5"/>
            <!-- Flow indicator -->
            ${open ? '<text x="25" y="24.5" text-anchor="middle" font-size="5" fill="var(--siemens)">â”â”</text>' : '<text x="25" y="24.5" text-anchor="middle" font-size="7" fill="#666">Ã—</text>'}
          </svg>
          <div class="hmi-motor-label">${w.label}</div>
          <div class="hmi-motor-rpm" style="color:${open?'var(--green)':'var(--text3)'}">${open?'OPEN':'CLOSED'}</div>
        </div>`;

    } else if (w.type === 'gauge') {
      const pct = sigVal ? 65 + Math.random()*10 : 0;
      const angle = -135 + (pct/100)*270;
      const rad = (angle * Math.PI) / 180;
      const cx = 36, cy = 36, r = 26;
      const nx = cx + r * Math.cos(rad), ny = cy + r * Math.sin(rad);
      div.innerHTML = `
        <div class="hmi-gauge">
          <svg class="hmi-gauge-svg" viewBox="0 0 72 72">
            <circle cx="36" cy="36" r="30" fill="#1a1e24" stroke="#333" stroke-width="2"/>
            <path d="M ${cx+r*Math.cos(-135*Math.PI/180)} ${cy+r*Math.sin(-135*Math.PI/180)} A ${r} ${r} 0 1 1 ${cx+r*Math.cos(135*Math.PI/180)} ${cy+r*Math.sin(135*Math.PI/180)}" fill="none" stroke="#333" stroke-width="4" stroke-linecap="round"/>
            <path d="M ${cx+r*Math.cos(-135*Math.PI/180)} ${cy+r*Math.sin(-135*Math.PI/180)} A ${r} ${r} 0 ${pct>50?1:0} 1 ${nx} ${ny}" fill="none" stroke="${pct>80?'var(--red)':pct>60?'var(--yellow)':'var(--green)'}" stroke-width="4" stroke-linecap="round"/>
            <line x1="${cx}" y1="${cy}" x2="${nx}" y2="${ny}" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <circle cx="${cx}" cy="${cy}" r="3" fill="#444"/>
            <text x="36" y="52" text-anchor="middle" font-size="8" fill="${sigVal?'var(--text)':'#555'}" font-family="'Share Tech Mono',monospace">${pct.toFixed(0)}%</text>
          </svg>
          <div class="hmi-motor-label">${w.label}</div>
        </div>`;
    }

    // Click to select (not drag)
    div.addEventListener('mousedown', (e) => {
      e.stopPropagation();
      startHMIDragWidget(e, w.id);
    });
    div.addEventListener('click', (e) => {
      e.stopPropagation();
      selectHMIWidget(w.id);
    });

    canvas.appendChild(div);
  });
}

function hmiPBDown(id) {
  const w = hmiWidgets.find(x => x.id === id);
  if (!w) return;
  if (w.type === 'pushbtn') {
    signals[w.addr] = signals[w.addr] || { val:false, forced:false, forcedVal:false, name:w.label, type:'I' };
    signals[w.addr].val = true;
    addLog('info','HMI',`PB ${w.label} (${w.addr}) â†’ ON`);
  } else if (w.type === 'pushbtn-nc') {
    // NC pushbtn: pressing opens the contact (sets the signal = true = activates NC logic)
    signals[w.addr] = signals[w.addr] || { val:false, forced:false, forcedVal:false, name:w.label, type:'I' };
    signals[w.addr].val = true;
    addLog('info','HMI',`PB-NC ${w.label} (${w.addr}) â†’ PRESSED (abre NC)`);
  }
}

function hmiPBUp(id) {
  const w = hmiWidgets.find(x => x.id === id);
  if (!w || !w.momentary) return;
  signals[w.addr] = signals[w.addr] || { val:false, forced:false, forcedVal:false, name:w.label, type:'I' };
  signals[w.addr].val = false;
  addLog('info','HMI',`PB ${w.label} (${w.addr}) â†’ OFF`);
}

function hmiToggleSwitch(id) {
  const w = hmiWidgets.find(x => x.id === id);
  if (!w) return;
  signals[w.addr] = signals[w.addr] || { val:false, forced:false, forcedVal:false, name:w.label, type:'I' };
  signals[w.addr].val = !signals[w.addr].val;
  addLog('info','HMI',`SW ${w.label} (${w.addr}) â†’ ${signals[w.addr].val?'ON':'OFF'}`);
  if (!state.running) { renderLadder(); updateIOTable(); }
}

function selectHMIWidget(id) {
  hmiSelectedId = id;
  const w = hmiWidgets.find(x => x.id === id);
  renderHMI();
  renderHMIProps(w);
}

function deselectHMI(e) {
  if (e.target === document.getElementById('hmiCanvas') || e.target === document.getElementById('hmiCanvasInner')) {
    hmiSelectedId = null;
    renderHMI();
    renderHMIProps(null);
  }
}

function renderHMIProps(w) {
  const c = document.getElementById('hmiPropsContent');
  if (!w) {
    c.innerHTML = '<div style="padding:16px 12px;font-size:11px;color:var(--text3);text-align:center;line-height:1.6">Selecciona un widget<br>para editar sus propiedades</div>';
    return;
  }
  c.innerHTML = `
    <div class="hmi-prop-row">
      <div class="hmi-prop-label">Tipo</div>
      <div style="font-size:11px;color:var(--siemens)">${w.type}</div>
    </div>
    <div class="hmi-prop-row">
      <div class="hmi-prop-label">Etiqueta</div>
      <input class="hmi-prop-input" value="${w.label}" oninput="updateHMIProp('${w.id}','label',this.value)">
    </div>
    <div class="hmi-prop-row">
      <div class="hmi-prop-label">DirecciÃ³n PLC</div>
      <input class="hmi-prop-input" value="${w.addr}" oninput="updateHMIProp('${w.id}','addr',this.value)" placeholder="Q0.0 / I0.0 / M0.0">
    </div>
    ${w.faultAddr !== undefined ? `
    <div class="hmi-prop-row">
      <div class="hmi-prop-label">Dir. Falla</div>
      <input class="hmi-prop-input" value="${w.faultAddr}" oninput="updateHMIProp('${w.id}','faultAddr',this.value)" placeholder="I0.5">
    </div>` : ''}
    <div class="hmi-prop-row">
      <div class="hmi-prop-label">PosiciÃ³n X</div>
      <input class="hmi-prop-input" type="number" value="${Math.round(w.x)}" oninput="updateHMIProp('${w.id}','x',+this.value)">
    </div>
    <div class="hmi-prop-row">
      <div class="hmi-prop-label">PosiciÃ³n Y</div>
      <input class="hmi-prop-input" type="number" value="${Math.round(w.y)}" oninput="updateHMIProp('${w.id}','y',+this.value)">
    </div>
    <div class="hmi-prop-row">
      <div class="hmi-prop-label">Estado actual</div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:11px;color:${getSignalVal(w.addr)?'var(--green)':'var(--text3)'}">${getSignalVal(w.addr)?'TRUE â—':'FALSE â—‹'}</div>
    </div>
    <div class="hmi-prop-row" style="margin-top:8px">
      <button class="tb-btn stop-btn" style="width:100%" onclick="deleteHMIWidget('${w.id}')">ðŸ—‘ Eliminar widget</button>
    </div>
  `;
}

function updateHMIProp(id, key, val) {
  const w = hmiWidgets.find(x => x.id === id);
  if (!w) return;
  w[key] = val;
  renderHMI();
}

function deleteHMIWidget(id) {
  hmiWidgets = hmiWidgets.filter(x => x.id !== id);
  hmiSelectedId = null;
  renderHMI();
  renderHMIProps(null);
}

// â”€â”€ HMI Drag to move widgets â”€â”€
function startHMIDragWidget(e, id) {
  if (e.button !== 0) return;
  const w = hmiWidgets.find(x => x.id === id);
  if (!w) return;
  const startX = e.clientX - w.x;
  const startY = e.clientY - w.y;
  let moved = false;

  const onMove = (ev) => {
    moved = true;
    w.x = Math.max(0, ev.clientX - startX);
    w.y = Math.max(0, ev.clientY - startY);
    const el = document.getElementById('hmiw-' + id);
    if (el) { el.style.left = w.x + 'px'; el.style.top = w.y + 'px'; }
  };
  const onUp = () => {
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
    if (!moved) selectHMIWidget(id);
    else renderHMIProps(hmiWidgets.find(x=>x.id===id));
  };
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
}

// â”€â”€ HMI window drag (titlebar) â”€â”€
function setupHMIDrag() {
  const tb = document.getElementById('hmiTitlebar');
  const win = document.getElementById('hmiWindow');
  if (!tb || !win) return;
  tb.onmousedown = (e) => {
    if (e.target.closest('button')) return;
    const ox = e.clientX - win.offsetLeft;
    const oy = e.clientY - win.offsetTop;
    const move = (ev) => {
      win.style.position = 'absolute';
      win.style.left = (ev.clientX - ox) + 'px';
      win.style.top  = (ev.clientY - oy) + 'px';
      win.style.margin = '0';
    };
    const up = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); };
    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', up);
  };
}

// Update HMI during scan
function updateHMI() {
  if (document.getElementById('hmiOverlay').classList.contains('open')) {
    renderHMI();
    if (hmiSelectedId) {
      const w = hmiWidgets.find(x=>x.id===hmiSelectedId);
      if (w) {
        const stEl = document.querySelector('#hmiPropsContent [style*="color:var(--green)"], #hmiPropsContent [style*="color:var(--text3)"]');
        if (stEl) { const v = getSignalVal(w.addr); stEl.style.color = v ? 'var(--green)' : 'var(--text3)'; stEl.textContent = v ? 'TRUE â—' : 'FALSE â—‹'; }
      }
    }
  }
}
renderLadder();
updateIOTable();
updateWatchTable();
addLog('info', 'SYS', 'PLC Simulator iniciado â€” CPU 1516-3 PN/DP');
addLog('info', 'SYS', 'Memoria cargada: OB1, FB1, FC1, DB1, DB2');
addLog('warn', 'SYS', 'CPU en modo STOP â€” presione RUN o SIMULAR para arrancar');
addLog('info', 'SYS', 'â–¶ RUN para ciclo real | âš¡ SIMULAR para modo online');
addLog('info', 'HMI', 'ðŸ–¥ Panel HMI disponible â€” botÃ³n en toolbar superior');
addLog('info', 'NET1', 'Enclavamiento: START(I0.0) âˆ¥ LATCH(M0.0) â†’ STOP-NC(I0.1) â†’ E-STOP-NC(I0.2) â†’ Motor_Run(Q0.0)');
renderDBPanel();
</script>
</body>
</html>
